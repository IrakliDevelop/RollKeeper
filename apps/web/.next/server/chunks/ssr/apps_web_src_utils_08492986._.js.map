{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/constants.ts"],"sourcesContent":["import {\r\n  AbilityName,\r\n  SkillName,\r\n  RichTextContent,\r\n  Weapon,\r\n  Spell,\r\n  TrackableTrait,\r\n  ExtendedFeature,\r\n  MagicItem,\r\n  ArmorItem,\r\n  InventoryItem,\r\n} from '@/types/character';\r\n\r\n// D&D 5e skill to ability mappings\r\nexport const SKILL_ABILITY_MAP: Record<SkillName, AbilityName> = {\r\n  acrobatics: 'dexterity',\r\n  animalHandling: 'wisdom',\r\n  arcana: 'intelligence',\r\n  athletics: 'strength',\r\n  deception: 'charisma',\r\n  history: 'intelligence',\r\n  insight: 'wisdom',\r\n  intimidation: 'charisma',\r\n  investigation: 'intelligence',\r\n  medicine: 'wisdom',\r\n  nature: 'intelligence',\r\n  perception: 'wisdom',\r\n  performance: 'charisma',\r\n  persuasion: 'charisma',\r\n  religion: 'intelligence',\r\n  sleightOfHand: 'dexterity',\r\n  stealth: 'dexterity',\r\n  survival: 'wisdom',\r\n};\r\n\r\n// Skill display names\r\nexport const SKILL_NAMES: Record<SkillName, string> = {\r\n  acrobatics: 'Acrobatics',\r\n  animalHandling: 'Animal Handling',\r\n  arcana: 'Arcana',\r\n  athletics: 'Athletics',\r\n  deception: 'Deception',\r\n  history: 'History',\r\n  insight: 'Insight',\r\n  intimidation: 'Intimidation',\r\n  investigation: 'Investigation',\r\n  medicine: 'Medicine',\r\n  nature: 'Nature',\r\n  perception: 'Perception',\r\n  performance: 'Performance',\r\n  persuasion: 'Persuasion',\r\n  religion: 'Religion',\r\n  sleightOfHand: 'Sleight of Hand',\r\n  stealth: 'Stealth',\r\n  survival: 'Survival',\r\n};\r\n\r\n// Ability score display names\r\nexport const ABILITY_NAMES: Record<AbilityName, string> = {\r\n  strength: 'Strength',\r\n  dexterity: 'Dexterity',\r\n  constitution: 'Constitution',\r\n  intelligence: 'Intelligence',\r\n  wisdom: 'Wisdom',\r\n  charisma: 'Charisma',\r\n};\r\n\r\n// Ability score abbreviations\r\nexport const ABILITY_ABBREVIATIONS: Record<AbilityName, string> = {\r\n  strength: 'STR',\r\n  dexterity: 'DEX',\r\n  constitution: 'CON',\r\n  intelligence: 'INT',\r\n  wisdom: 'WIS',\r\n  charisma: 'CHA',\r\n};\r\n\r\n// Proficiency bonus by level (D&D 5e)\r\nexport const PROFICIENCY_BONUS_BY_LEVEL: Record<number, number> = {\r\n  1: 2,\r\n  2: 2,\r\n  3: 2,\r\n  4: 2,\r\n  5: 3,\r\n  6: 3,\r\n  7: 3,\r\n  8: 3,\r\n  9: 4,\r\n  10: 4,\r\n  11: 4,\r\n  12: 4,\r\n  13: 5,\r\n  14: 5,\r\n  15: 5,\r\n  16: 5,\r\n  17: 6,\r\n  18: 6,\r\n  19: 6,\r\n  20: 6,\r\n};\r\n\r\n// Experience points required for each level (D&D 5e)\r\nexport const XP_THRESHOLDS: Record<number, number> = {\r\n  1: 0,\r\n  2: 300,\r\n  3: 900,\r\n  4: 2700,\r\n  5: 6500,\r\n  6: 14000,\r\n  7: 23000,\r\n  8: 34000,\r\n  9: 48000,\r\n  10: 64000,\r\n  11: 85000,\r\n  12: 100000,\r\n  13: 120000,\r\n  14: 140000,\r\n  15: 165000,\r\n  16: 195000,\r\n  17: 225000,\r\n  18: 265000,\r\n  19: 305000,\r\n  20: 355000,\r\n};\r\n\r\n// Common D&D races\r\nexport const COMMON_RACES = [\r\n  'Human',\r\n  'Elf',\r\n  'Dwarf',\r\n  'Halfling',\r\n  'Dragonborn',\r\n  'Gnome',\r\n  'Half-Elf',\r\n  'Half-Orc',\r\n  'Tiefling',\r\n  'Aarakocra',\r\n  'Aasimar',\r\n  'Bugbear',\r\n  'Centaur',\r\n  'Changeling',\r\n  'Firbolg',\r\n  'Genasi',\r\n  'Githyanki',\r\n  'Githzerai',\r\n  'Goblin',\r\n  'Goliath',\r\n  'Hobgoblin',\r\n  'Kenku',\r\n  'Kobold',\r\n  'Lizardfolk',\r\n  'Minotaur',\r\n  'Orc',\r\n  'Satyr',\r\n  'Tabaxi',\r\n  'Triton',\r\n  'Warforged',\r\n  'Yuan-Ti',\r\n];\r\n\r\n// Fallback race options for autocomplete when API fails\r\nexport const FALLBACK_RACE_OPTIONS = [\r\n  { value: 'Human', label: 'Human' },\r\n  { value: 'Elf', label: 'Elf' },\r\n  { value: 'Dwarf', label: 'Dwarf' },\r\n  { value: 'Halfling', label: 'Halfling' },\r\n  { value: 'Dragonborn', label: 'Dragonborn' },\r\n  { value: 'Gnome', label: 'Gnome' },\r\n  { value: 'Half-Elf', label: 'Half-Elf' },\r\n  { value: 'Half-Orc', label: 'Half-Orc' },\r\n  { value: 'Tiefling', label: 'Tiefling' },\r\n];\r\n\r\n// Hit dice for each D&D 5e class\r\nexport const CLASS_HIT_DICE: Record<string, number> = {\r\n  Barbarian: 12,\r\n  Fighter: 10,\r\n  Paladin: 10,\r\n  Ranger: 10,\r\n  Artificer: 8,\r\n  Bard: 8,\r\n  Cleric: 8,\r\n  Druid: 8,\r\n  Monk: 8,\r\n  Rogue: 8,\r\n  Warlock: 8,\r\n  Sorcerer: 6,\r\n  Wizard: 6,\r\n  'Blood Hunter': 10, // Critical Role homebrew class\r\n};\r\n\r\n// Common D&D classes with spellcaster and hit die information\r\nexport const COMMON_CLASSES: Array<{\r\n  name: string;\r\n  spellcaster: 'full' | 'half' | 'third' | 'warlock' | 'none';\r\n  hitDie: number;\r\n}> = [\r\n  { name: 'Barbarian', spellcaster: 'none', hitDie: 12 },\r\n  { name: 'Bard', spellcaster: 'full', hitDie: 8 },\r\n  { name: 'Cleric', spellcaster: 'full', hitDie: 8 },\r\n  { name: 'Druid', spellcaster: 'full', hitDie: 8 },\r\n  { name: 'Fighter', spellcaster: 'third', hitDie: 10 }, // Eldritch Knight\r\n  { name: 'Monk', spellcaster: 'none', hitDie: 8 },\r\n  { name: 'Paladin', spellcaster: 'half', hitDie: 10 },\r\n  { name: 'Ranger', spellcaster: 'half', hitDie: 10 },\r\n  { name: 'Rogue', spellcaster: 'third', hitDie: 8 }, // Arcane Trickster\r\n  { name: 'Sorcerer', spellcaster: 'full', hitDie: 6 },\r\n  { name: 'Warlock', spellcaster: 'warlock', hitDie: 8 },\r\n  { name: 'Wizard', spellcaster: 'full', hitDie: 6 },\r\n  { name: 'Artificer', spellcaster: 'half', hitDie: 8 },\r\n  { name: 'Blood Hunter', spellcaster: 'none', hitDie: 10 },\r\n];\r\n\r\n// Spell slots by level for full casters\r\nexport const FULL_CASTER_SPELL_SLOTS: Record<number, Record<number, number>> = {\r\n  1: { 1: 2 },\r\n  2: { 1: 3 },\r\n  3: { 1: 4, 2: 2 },\r\n  4: { 1: 4, 2: 3 },\r\n  5: { 1: 4, 2: 3, 3: 2 },\r\n  6: { 1: 4, 2: 3, 3: 3 },\r\n  7: { 1: 4, 2: 3, 3: 3, 4: 1 },\r\n  8: { 1: 4, 2: 3, 3: 3, 4: 2 },\r\n  9: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 1 },\r\n  10: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2 },\r\n  11: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1 },\r\n  12: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1 },\r\n  13: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1 },\r\n  14: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1 },\r\n  15: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1 },\r\n  16: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1 },\r\n  17: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1, 9: 1 },\r\n  18: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 1, 7: 1, 8: 1, 9: 1 },\r\n  19: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 2, 7: 1, 8: 1, 9: 1 },\r\n  20: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 2, 7: 2, 8: 1, 9: 1 },\r\n};\r\n\r\n// Spell slots by level for half casters (Paladin, Ranger, Artificer)\r\nexport const HALF_CASTER_SPELL_SLOTS: Record<number, Record<number, number>> = {\r\n  1: {},\r\n  2: { 1: 2 },\r\n  3: { 1: 3 },\r\n  4: { 1: 3 },\r\n  5: { 1: 4, 2: 2 },\r\n  6: { 1: 4, 2: 2 },\r\n  7: { 1: 4, 2: 3 },\r\n  8: { 1: 4, 2: 3 },\r\n  9: { 1: 4, 2: 3, 3: 2 },\r\n  10: { 1: 4, 2: 3, 3: 2 },\r\n  11: { 1: 4, 2: 3, 3: 3 },\r\n  12: { 1: 4, 2: 3, 3: 3 },\r\n  13: { 1: 4, 2: 3, 3: 3, 4: 1 },\r\n  14: { 1: 4, 2: 3, 3: 3, 4: 1 },\r\n  15: { 1: 4, 2: 3, 3: 3, 4: 2 },\r\n  16: { 1: 4, 2: 3, 3: 3, 4: 2 },\r\n  17: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 1 },\r\n  18: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 1 },\r\n  19: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2 },\r\n  20: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2 },\r\n};\r\n\r\n// Spell slots by level for third casters (Eldritch Knight, Arcane Trickster)\r\nexport const THIRD_CASTER_SPELL_SLOTS: Record<\r\n  number,\r\n  Record<number, number>\r\n> = {\r\n  1: {},\r\n  2: {},\r\n  3: { 1: 2 },\r\n  4: { 1: 3 },\r\n  5: {},\r\n  6: {},\r\n  7: { 1: 4, 2: 2 },\r\n  8: { 1: 4, 2: 2 },\r\n  9: {},\r\n  10: { 1: 4, 2: 3 },\r\n  11: { 1: 4, 2: 3 },\r\n  12: {},\r\n  13: { 1: 4, 2: 3, 3: 2 },\r\n  14: { 1: 4, 2: 3, 3: 2 },\r\n  15: {},\r\n  16: { 1: 4, 2: 3, 3: 3 },\r\n  17: {},\r\n  18: {},\r\n  19: { 1: 4, 2: 3, 3: 3, 4: 1 },\r\n  20: { 1: 4, 2: 3, 3: 3, 4: 1 },\r\n};\r\n\r\n// Warlock pact magic slots\r\nexport const WARLOCK_PACT_SLOTS: Record<\r\n  number,\r\n  { slots: number; level: number }\r\n> = {\r\n  1: { slots: 1, level: 1 },\r\n  2: { slots: 2, level: 1 },\r\n  3: { slots: 2, level: 2 },\r\n  4: { slots: 2, level: 2 },\r\n  5: { slots: 2, level: 3 },\r\n  6: { slots: 2, level: 3 },\r\n  7: { slots: 2, level: 4 },\r\n  8: { slots: 2, level: 4 },\r\n  9: { slots: 2, level: 5 },\r\n  10: { slots: 2, level: 5 },\r\n  11: { slots: 3, level: 5 },\r\n  12: { slots: 3, level: 5 },\r\n  13: { slots: 3, level: 5 },\r\n  14: { slots: 3, level: 5 },\r\n  15: { slots: 3, level: 5 },\r\n  16: { slots: 3, level: 5 },\r\n  17: { slots: 4, level: 5 },\r\n  18: { slots: 4, level: 5 },\r\n  19: { slots: 4, level: 5 },\r\n  20: { slots: 4, level: 5 },\r\n};\r\n\r\n// Common alignments\r\nexport const ALIGNMENTS = [\r\n  'Lawful Good',\r\n  'Neutral Good',\r\n  'Chaotic Good',\r\n  'Lawful Neutral',\r\n  'True Neutral',\r\n  'Chaotic Neutral',\r\n  'Lawful Evil',\r\n  'Neutral Evil',\r\n  'Chaotic Evil',\r\n];\r\n\r\n// Common backgrounds\r\nexport const BACKGROUNDS = [\r\n  'Acolyte',\r\n  'Criminal',\r\n  'Folk Hero',\r\n  'Noble',\r\n  'Sage',\r\n  'Soldier',\r\n  'Charlatan',\r\n  'Entertainer',\r\n  'Guild Artisan',\r\n  'Hermit',\r\n  'Outlander',\r\n  'Sailor',\r\n];\r\n\r\n// Default character state\r\nexport const DEFAULT_CHARACTER_STATE = {\r\n  name: '',\r\n  race: '',\r\n  class: {\r\n    name: '',\r\n    isCustom: false,\r\n    spellcaster: 'none' as const,\r\n    hitDie: 8, // Default to d8 for unknown/empty classes\r\n  },\r\n  level: 1,\r\n  experience: 0,\r\n  background: '',\r\n  alignment: '',\r\n  playerName: '',\r\n\r\n  abilities: {\r\n    strength: 10,\r\n    dexterity: 10,\r\n    constitution: 10,\r\n    intelligence: 10,\r\n    wisdom: 10,\r\n    charisma: 10,\r\n  },\r\n\r\n  skills: {\r\n    acrobatics: { proficient: false, expertise: false },\r\n    animalHandling: { proficient: false, expertise: false },\r\n    arcana: { proficient: false, expertise: false },\r\n    athletics: { proficient: false, expertise: false },\r\n    deception: { proficient: false, expertise: false },\r\n    history: { proficient: false, expertise: false },\r\n    insight: { proficient: false, expertise: false },\r\n    intimidation: { proficient: false, expertise: false },\r\n    investigation: { proficient: false, expertise: false },\r\n    medicine: { proficient: false, expertise: false },\r\n    nature: { proficient: false, expertise: false },\r\n    perception: { proficient: false, expertise: false },\r\n    performance: { proficient: false, expertise: false },\r\n    persuasion: { proficient: false, expertise: false },\r\n    religion: { proficient: false, expertise: false },\r\n    sleightOfHand: { proficient: false, expertise: false },\r\n    stealth: { proficient: false, expertise: false },\r\n    survival: { proficient: false, expertise: false },\r\n  },\r\n\r\n  hitPoints: {\r\n    current: 8,\r\n    max: 8,\r\n    temporary: 0,\r\n    calculationMode: 'auto' as const,\r\n    manualMaxOverride: undefined,\r\n    deathSaves: undefined,\r\n  },\r\n\r\n  deathSavingThrows: {\r\n    successes: 0,\r\n    failures: 0,\r\n    isStabilized: false,\r\n  },\r\n\r\n  armorClass: 10,\r\n  tempArmorClass: 0,\r\n  isWearingShield: false,\r\n  shieldBonus: 2,\r\n  initiative: {\r\n    value: 0,\r\n    isOverridden: false,\r\n  },\r\n  reaction: {\r\n    hasUsedReaction: false,\r\n  },\r\n  speed: 30,\r\n  hitDice: '1d8',\r\n\r\n  savingThrows: {\r\n    strength: { proficient: false },\r\n    dexterity: { proficient: false },\r\n    constitution: { proficient: false },\r\n    intelligence: { proficient: false },\r\n    wisdom: { proficient: false },\r\n    charisma: { proficient: false },\r\n  },\r\n\r\n  spellSlots: {\r\n    1: { max: 0, used: 0 },\r\n    2: { max: 0, used: 0 },\r\n    3: { max: 0, used: 0 },\r\n    4: { max: 0, used: 0 },\r\n    5: { max: 0, used: 0 },\r\n    6: { max: 0, used: 0 },\r\n    7: { max: 0, used: 0 },\r\n    8: { max: 0, used: 0 },\r\n    9: { max: 0, used: 0 },\r\n  },\r\n\r\n  heroicInspiration: {\r\n    count: 0,\r\n    maxCount: undefined,\r\n  },\r\n\r\n  trackableTraits: [] as TrackableTrait[],\r\n\r\n  extendedFeatures: [] as ExtendedFeature[],\r\n\r\n  features: [] as RichTextContent[],\r\n  traits: [] as RichTextContent[],\r\n  notes: [] as RichTextContent[],\r\n  characterBackground: {\r\n    backstory: '',\r\n    personality: '',\r\n    ideals: '',\r\n    bonds: '',\r\n    flaws: '',\r\n  },\r\n\r\n  weapons: [] as Weapon[],\r\n  magicItems: [] as MagicItem[],\r\n  armorItems: [] as ArmorItem[],\r\n  inventoryItems: [] as InventoryItem[],\r\n  currency: {\r\n    copper: 0,\r\n    silver: 0,\r\n    electrum: 0,\r\n    gold: 0,\r\n    platinum: 0,\r\n  },\r\n  attunementSlots: {\r\n    used: 0,\r\n    max: 3,\r\n  },\r\n  weaponProficiencies: {\r\n    simpleWeapons: false,\r\n    martialWeapons: false,\r\n    specificWeapons: [],\r\n  },\r\n\r\n  spells: [] as Spell[],\r\n  spellcastingStats: {\r\n    spellcastingAbility: null,\r\n    isAbilityOverridden: false,\r\n    customSpellcastingAbility: null,\r\n    spellAttackBonus: undefined,\r\n    spellSaveDC: undefined,\r\n  },\r\n\r\n  concentration: {\r\n    isConcentrating: false,\r\n    spellName: undefined,\r\n    spellId: undefined,\r\n    castAt: undefined,\r\n    startedAt: undefined,\r\n  },\r\n\r\n  // Spellbook system\r\n  spellbook: {\r\n    knownSpells: [],\r\n    preparedSpells: [],\r\n    favoriteSpells: [],\r\n    customSpells: [],\r\n    spellbookSettings: {\r\n      showOnlyClassSpells: true,\r\n      showOnlyKnownSpells: false,\r\n      preferredSources: ['PHB', 'XGE', 'TCE'],\r\n      spellbookName: 'My Spellbook',\r\n      theme: 'classic' as const,\r\n    },\r\n  },\r\n\r\n  // Conditions and diseases\r\n  conditionsAndDiseases: {\r\n    activeConditions: [],\r\n    activeDiseases: [],\r\n    exhaustionVariant: '2024' as const, // Default to 2024 rules\r\n  },\r\n\r\n  // Class Features\r\n  jackOfAllTrades: false, // Bard feature: add half proficiency to non-proficient skills\r\n  languages: [], // Known languages\r\n  toolProficiencies: [], // Tool proficiencies with levels\r\n\r\n  // Campaign Tracking\r\n  daysSpent: 0, // Number of in-game days spent in the campaign\r\n};\r\n\r\n// spell source books and colors mapping, key should be SPELL_SOURCE_BOOKS keys\r\nexport const SPELL_SOURCE_COLORS: Record<string, string> = {\r\n  PHB: 'bg-blue-500',\r\n  PHB2024: 'bg-indigo-500',\r\n  XPHB: 'bg-violet-500',\r\n  XGE: 'bg-green-500',\r\n  TCE: 'bg-red-500',\r\n  ERLW: 'bg-amber-500',\r\n  AI: 'bg-cyan-500',\r\n  AAG: 'bg-teal-500',\r\n  EEPC: 'bg-emerald-500',\r\n  EGW: 'bg-sky-500',\r\n  RMR: 'bg-purple-500',\r\n  FTD: 'bg-fuchsia-500',\r\n  GGR: 'bg-rose-500',\r\n  IDRotF: 'bg-orange-500',\r\n  MOTF: 'bg-yellow-500',\r\n  MTG: 'bg-lime-500',\r\n  SatO: 'bg-pink-500',\r\n  SCC: 'bg-slate-500',\r\n  SCAG: 'bg-zinc-500',\r\n  TDCSR: 'bg-emerald-600',\r\n  BMT: 'bg-violet-600',\r\n  BoET: 'bg-indigo-600',\r\n  DoDk: 'bg-blue-600',\r\n  GHLoE: 'bg-cyan-600',\r\n  VG: 'bg-teal-600',\r\n  'AitFR-AVT': 'bg-green-600',\r\n};\r\n\r\nexport const SPELL_SOURCE_BOOKS: Record<string, string> = {\r\n  PHB: \"Player's Handbook\",\r\n  PHB2024: \"Player's Handbook 2024\",\r\n  XPHB: \"Player's Handbook 2024\",\r\n  XGE: \"Xanathar's Guide to Everything\",\r\n  TCE: \"Tasha's Cauldron of Everything\",\r\n  ERLW: 'Eberron: Rising from the Last War',\r\n  AI: 'Acquisitions Incorporated',\r\n  AAG: `Astral Adventurers Guild`,\r\n  EEPC: `Elemental Evil Player's Companion`,\r\n  EGW: `Explorer's Guide to Wildemount`,\r\n  RMR: `Dungeons & Dragons vs Rick & Morty`,\r\n  FTD: `Fizban's Treasury of Dragons`,\r\n  GGR: `Guildmasters' Guide to Ravnica`,\r\n  IDRotF: `Icewind Dale: Rime of the Frostmaiden`,\r\n  MOTF: `Mythic Odysseys of Theros`,\r\n  MTG: `Magic: The Gathering`,\r\n  SatO: 'Sigil and the Outlands',\r\n  SCC: 'Strixhaven: A Curriculum of Chaos',\r\n  SCAG: \"Sword Coast Adventurer's Guide\",\r\n  TDCSR: `Tal'Dorei Campaign Setting Reborn`,\r\n  BMT: 'The Book of Many Things',\r\n  BoET: 'Book of Ebon Tides',\r\n  DoDk: 'Dungeons of Drakkenheim',\r\n  GHLoE: 'Grim Hollow: Lairs of Etharis',\r\n  VG: \"Volo's Guide to Monsters\",\r\n  'AitFR-AVT': `Adventures in the Forgotten Realms: A Verdant Tomb`,\r\n  'AitFR-FCD': `Adventures in the Forgotten Realms: From Cyan Depths`,\r\n  LLK: 'Lost Laboratory of Kwalish',\r\n  DMG: \"Dungeon Master's Guide\",\r\n  DMG2024: \"Dungeon Master's Guide 2024\",\r\n  XDMG: \"Dungeon Master's Guide 2024\",\r\n};\r\n\r\n// Auto-save settings\r\nexport const AUTOSAVE_DELAY = 500; // ms\r\nexport const STORAGE_KEY = 'rollkeeper-character';\r\nexport const APP_VERSION = '1.0.0';\r\n\r\n// Avatar upload settings\r\nexport const MAX_AVATAR_SIZE_MB = 5; // Maximum avatar file size in megabytes\r\nexport const MAX_AVATAR_SIZE_BYTES = MAX_AVATAR_SIZE_MB * 1024 * 1024;\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1062, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/calculations.ts"],"sourcesContent":["import {\r\n  SkillName,\r\n  AbilityName,\r\n  CharacterState,\r\n  SpellSlots,\r\n  PactMagic,\r\n  ClassInfo,\r\n  MulticlassInfo,\r\n  HitDicePools,\r\n  Weapon,\r\n  SpellcastingAbility,\r\n  TrackableTrait,\r\n} from '@/types/character';\r\nimport {\r\n  SKILL_ABILITY_MAP,\r\n  PROFICIENCY_BONUS_BY_LEVEL,\r\n  FULL_CASTER_SPELL_SLOTS,\r\n  HALF_CASTER_SPELL_SLOTS,\r\n  THIRD_CASTER_SPELL_SLOTS,\r\n  WARLOCK_PACT_SLOTS,\r\n  XP_THRESHOLDS,\r\n} from './constants';\r\n\r\n/**\r\n * Calculate ability modifier from ability score\r\n * D&D 5e: modifier = floor((score - 10) / 2)\r\n */\r\nexport const calculateModifier = (score: number): number => {\r\n  return Math.floor((score - 10) / 2);\r\n};\r\n\r\n/**\r\n * Get proficiency bonus based on character level\r\n */\r\nexport const getProficiencyBonus = (level: number): number => {\r\n  const clampedLevel = Math.max(1, Math.min(20, level));\r\n  return PROFICIENCY_BONUS_BY_LEVEL[clampedLevel] || 2;\r\n};\r\n\r\n/**\r\n * Calculate skill modifier\r\n * Takes into account ability modifier, proficiency, expertise, and Jack of All Trades\r\n */\r\nexport const calculateSkillModifier = (\r\n  character: CharacterState,\r\n  skillName: SkillName\r\n): number => {\r\n  const skill = character.skills[skillName];\r\n  const relatedAbility = SKILL_ABILITY_MAP[skillName];\r\n  const abilityScore = character.abilities[relatedAbility];\r\n  const abilityModifier = calculateModifier(abilityScore);\r\n  const proficiencyBonus = getProficiencyBonus(character.level);\r\n\r\n  let modifier = abilityModifier;\r\n\r\n  // Add proficiency bonus if proficient\r\n  if (skill.proficient) {\r\n    modifier += proficiencyBonus;\r\n  } else if (character.jackOfAllTrades) {\r\n    // Jack of All Trades: add half proficiency bonus (rounded down) to non-proficient skills\r\n    modifier += Math.floor(proficiencyBonus / 2);\r\n  }\r\n\r\n  // Double proficiency bonus for expertise\r\n  if (skill.expertise && skill.proficient) {\r\n    modifier += proficiencyBonus;\r\n  }\r\n\r\n  // Add any custom modifier\r\n  if (skill.customModifier !== undefined) {\r\n    modifier += skill.customModifier;\r\n  }\r\n\r\n  return modifier;\r\n};\r\n\r\n/**\r\n * Calculate saving throw modifier\r\n */\r\nexport const calculateSavingThrowModifier = (\r\n  character: CharacterState,\r\n  ability: AbilityName\r\n): number => {\r\n  const abilityScore = character.abilities[ability];\r\n  const abilityModifier = calculateModifier(abilityScore);\r\n  const savingThrow = character.savingThrows[ability];\r\n  const proficiencyBonus = getProficiencyBonus(character.level);\r\n\r\n  let modifier = abilityModifier;\r\n\r\n  // Add proficiency bonus if proficient\r\n  if (savingThrow.proficient) {\r\n    modifier += proficiencyBonus;\r\n  }\r\n\r\n  // Add any custom modifier\r\n  if (savingThrow.customModifier !== undefined) {\r\n    modifier += savingThrow.customModifier;\r\n  }\r\n\r\n  return modifier;\r\n};\r\n\r\n/**\r\n * Calculate initiative modifier (Dexterity modifier)\r\n */\r\nexport const calculateInitiativeModifier = (\r\n  character: CharacterState\r\n): number => {\r\n  return calculateModifier(character.abilities.dexterity);\r\n};\r\n\r\n/**\r\n * Calculate total armor class including all bonuses\r\n * @param baseAC - Base armor class\r\n * @param tempAC - Temporary AC bonuses from spells/effects\r\n * @param isWearingShield - Whether character is wearing a shield\r\n * @param shieldBonus - AC bonus from shield (default +2 for standard shield)\r\n */\r\nexport const calculateTotalArmorClass = (\r\n  baseAC: number,\r\n  tempAC: number,\r\n  isWearingShield: boolean,\r\n  shieldBonus: number = 2\r\n): number => {\r\n  return baseAC + tempAC + (isWearingShield ? shieldBonus : 0);\r\n};\r\n\r\n/**\r\n * Calculate total armor class from character state\r\n */\r\nexport const calculateCharacterArmorClass = (\r\n  character: CharacterState\r\n): number => {\r\n  return calculateTotalArmorClass(\r\n    character.armorClass,\r\n    character.tempArmorClass,\r\n    character.isWearingShield,\r\n    character.shieldBonus\r\n  );\r\n};\r\n\r\n/**\r\n * Calculate passive perception\r\n * Passive perception = 10 + Perception skill modifier\r\n */\r\nexport const calculatePassivePerception = (\r\n  character: CharacterState\r\n): number => {\r\n  const perceptionModifier = calculateSkillModifier(character, 'perception');\r\n  return 10 + perceptionModifier;\r\n};\r\n\r\n/**\r\n * Calculate hit point maximum based on level and constitution\r\n * This is a simplified calculation - in reality it depends on class hit die\r\n */\r\nexport const calculateHitPointMaximum = (\r\n  character: CharacterState,\r\n  hitDieType: number = 8 // Default d8, could be passed from class data\r\n): number => {\r\n  const constitutionModifier = calculateModifier(\r\n    character.abilities.constitution\r\n  );\r\n  const level = character.level;\r\n\r\n  // First level gets max hit die + con mod\r\n  // Subsequent levels get average of hit die + con mod\r\n  const firstLevelHP = hitDieType + constitutionModifier;\r\n  const additionalLevelsHP =\r\n    (level - 1) * (Math.floor(hitDieType / 2) + 1 + constitutionModifier);\r\n\r\n  return Math.max(1, firstLevelHP + additionalLevelsHP);\r\n};\r\n\r\n/**\r\n * Calculate carrying capacity (Strength score × 15)\r\n */\r\nexport const calculateCarryingCapacity = (\r\n  character: CharacterState\r\n): number => {\r\n  return character.abilities.strength * 15;\r\n};\r\n\r\n/**\r\n * Format modifier with proper + or - sign\r\n */\r\nexport const formatModifier = (modifier: number): string => {\r\n  if (modifier >= 0) {\r\n    return `+${modifier}`;\r\n  }\r\n  return modifier.toString();\r\n};\r\n\r\n/**\r\n * Get all calculated fields for a character\r\n * Useful for displaying computed values\r\n */\r\nexport const getCalculatedFields = (character: CharacterState) => {\r\n  const abilityModifiers = {\r\n    strength: calculateModifier(character.abilities.strength),\r\n    dexterity: calculateModifier(character.abilities.dexterity),\r\n    constitution: calculateModifier(character.abilities.constitution),\r\n    intelligence: calculateModifier(character.abilities.intelligence),\r\n    wisdom: calculateModifier(character.abilities.wisdom),\r\n    charisma: calculateModifier(character.abilities.charisma),\r\n  };\r\n\r\n  const skillModifiers = Object.keys(character.skills).reduce(\r\n    (acc, skillName) => {\r\n      acc[skillName as SkillName] = calculateSkillModifier(\r\n        character,\r\n        skillName as SkillName\r\n      );\r\n      return acc;\r\n    },\r\n    {} as Record<SkillName, number>\r\n  );\r\n\r\n  const savingThrowModifiers = Object.keys(character.savingThrows).reduce(\r\n    (acc, abilityName) => {\r\n      acc[abilityName as AbilityName] = calculateSavingThrowModifier(\r\n        character,\r\n        abilityName as AbilityName\r\n      );\r\n      return acc;\r\n    },\r\n    {} as Record<AbilityName, number>\r\n  );\r\n\r\n  return {\r\n    proficiencyBonus: getProficiencyBonus(character.level),\r\n    abilityModifiers,\r\n    skillModifiers,\r\n    savingThrowModifiers,\r\n    initiativeModifier: calculateInitiativeModifier(character),\r\n    passivePerception: calculatePassivePerception(character),\r\n    carryingCapacity: calculateCarryingCapacity(character),\r\n  };\r\n};\r\n\r\n/**\r\n * Check if character is proficient with a weapon\r\n */\r\nexport const isWeaponProficient = (\r\n  character: CharacterState,\r\n  weapon: Weapon\r\n): boolean => {\r\n  // Check manual proficiency override first\r\n  if (weapon.manualProficiency !== undefined) {\r\n    return weapon.manualProficiency;\r\n  }\r\n\r\n  // Check category proficiency\r\n  if (\r\n    weapon.category === 'simple' &&\r\n    character.weaponProficiencies.simpleWeapons\r\n  ) {\r\n    return true;\r\n  }\r\n  if (\r\n    weapon.category === 'martial' &&\r\n    character.weaponProficiencies.martialWeapons\r\n  ) {\r\n    return true;\r\n  }\r\n\r\n  // Check specific weapon proficiency\r\n  return character.weaponProficiencies.specificWeapons.includes(\r\n    weapon.name.toLowerCase()\r\n  );\r\n};\r\n\r\n/**\r\n * Get the appropriate ability modifier for a weapon attack\r\n */\r\nexport const getWeaponAbilityModifier = (\r\n  character: CharacterState,\r\n  weapon: Weapon\r\n): number => {\r\n  // Finesse weapons can use DEX or STR (we'll use the higher one)\r\n  if (weapon.weaponType.includes('finesse')) {\r\n    return Math.max(\r\n      calculateModifier(character.abilities.strength),\r\n      calculateModifier(character.abilities.dexterity)\r\n    );\r\n  }\r\n\r\n  // Ranged weapons use DEX\r\n  if (weapon.weaponType.includes('ranged')) {\r\n    return calculateModifier(character.abilities.dexterity);\r\n  }\r\n\r\n  // Melee weapons use STR by default\r\n  return calculateModifier(character.abilities.strength);\r\n};\r\n\r\n/**\r\n * Calculate weapon attack bonus\r\n */\r\nexport const calculateWeaponAttackBonus = (\r\n  character: CharacterState,\r\n  weapon: Weapon\r\n): number => {\r\n  let attackBonus = 0;\r\n\r\n  // Add ability modifier\r\n  attackBonus += getWeaponAbilityModifier(character, weapon);\r\n\r\n  // Add proficiency bonus if proficient\r\n  if (isWeaponProficient(character, weapon)) {\r\n    attackBonus += getProficiencyBonus(character.level);\r\n  }\r\n\r\n  // Add enhancement bonus\r\n  attackBonus += weapon.enhancementBonus;\r\n\r\n  // Add custom attack bonus\r\n  if (weapon.attackBonus) {\r\n    attackBonus += weapon.attackBonus;\r\n  }\r\n\r\n  return attackBonus;\r\n};\r\n\r\n/**\r\n * Calculate weapon damage bonus (not including dice)\r\n */\r\nexport const calculateWeaponDamageBonus = (\r\n  character: CharacterState,\r\n  weapon: Weapon\r\n): number => {\r\n  let damageBonus = 0;\r\n\r\n  // Add ability modifier\r\n  damageBonus += getWeaponAbilityModifier(character, weapon);\r\n\r\n  // Add enhancement bonus\r\n  damageBonus += weapon.enhancementBonus;\r\n\r\n  // Add custom damage bonus\r\n  if (weapon.damageBonus) {\r\n    damageBonus += weapon.damageBonus;\r\n  }\r\n\r\n  return damageBonus;\r\n};\r\n\r\n/**\r\n * Get weapon attack string for display (e.g., \"+7 to hit\")\r\n */\r\nexport const getWeaponAttackString = (\r\n  character: CharacterState,\r\n  weapon: Weapon\r\n): string => {\r\n  const attackBonus = calculateWeaponAttackBonus(character, weapon);\r\n  return `${formatModifier(attackBonus)} to hit`;\r\n};\r\n\r\n/**\r\n * Get weapon damage string for display (e.g., \"1d8+3 slashing, 1d6 fire\")\r\n */\r\nexport const getWeaponDamageString = (\r\n  character: CharacterState,\r\n  weapon: Weapon,\r\n  versatile = false\r\n): string => {\r\n  const damageBonus = calculateWeaponDamageBonus(character, weapon);\r\n\r\n  // Handle backward compatibility - check if damage is old format (object) or new format (array)\r\n  if (!Array.isArray(weapon.damage)) {\r\n    // Old format: weapon.damage is an object with dice, type, versatiledice\r\n    const legacyDamage = weapon.damage as {\r\n      dice: string;\r\n      type: string;\r\n      versatiledice?: string;\r\n    };\r\n    if (legacyDamage && legacyDamage.dice && legacyDamage.type) {\r\n      const dice =\r\n        versatile && legacyDamage.versatiledice\r\n          ? legacyDamage.versatiledice\r\n          : legacyDamage.dice;\r\n\r\n      if (damageBonus === 0) {\r\n        return `${dice} ${legacyDamage.type}`;\r\n      }\r\n\r\n      return `${dice}${formatModifier(damageBonus)} ${legacyDamage.type}`;\r\n    }\r\n    return 'No damage';\r\n  }\r\n\r\n  // New format: weapon.damage is an array\r\n  if (weapon.damage.length === 0) {\r\n    return 'No damage';\r\n  }\r\n\r\n  const damageStrings = weapon.damage.map((damage, index) => {\r\n    const dice =\r\n      versatile && damage.versatiledice ? damage.versatiledice : damage.dice;\r\n    const bonus = index === 0 ? damageBonus : 0; // Only add weapon damage bonus to first damage\r\n\r\n    if (bonus === 0) {\r\n      return `${dice} ${damage.type}`;\r\n    }\r\n\r\n    return `${dice}${formatModifier(bonus)} ${damage.type}`;\r\n  });\r\n\r\n  return damageStrings.join(', ');\r\n};\r\n\r\n/**\r\n * Roll damage dice and return result string\r\n */\r\nexport const rollDamage = (dice: string, bonus = 0): string => {\r\n  // Parse dice string (e.g., \"1d8\", \"2d6\", \"3d4+2\")\r\n  const diceMatch = dice.match(/(\\d+)d(\\d+)(?:\\+(\\d+))?(?:-(\\d+))?/i);\r\n  if (!diceMatch) {\r\n    // If not a valid dice string, return as-is\r\n    return dice;\r\n  }\r\n\r\n  const numDice = parseInt(diceMatch[1]);\r\n  const dieSize = parseInt(diceMatch[2]);\r\n  const diceBonus = diceMatch[3]\r\n    ? parseInt(diceMatch[3])\r\n    : diceMatch[4]\r\n      ? -parseInt(diceMatch[4])\r\n      : 0;\r\n\r\n  let total = 0;\r\n  const rolls: number[] = [];\r\n\r\n  // Roll each die\r\n  for (let i = 0; i < numDice; i++) {\r\n    const roll = Math.floor(Math.random() * dieSize) + 1;\r\n    rolls.push(roll);\r\n    total += roll;\r\n  }\r\n\r\n  // Add bonuses\r\n  total += diceBonus + bonus;\r\n\r\n  // Format result\r\n  if (numDice === 1) {\r\n    return `${total}${diceBonus + bonus !== 0 ? ` (${rolls[0]}${diceBonus + bonus > 0 ? `+${diceBonus + bonus}` : diceBonus + bonus})` : ''}`;\r\n  } else {\r\n    return `${total} (${rolls.join('+')}${diceBonus + bonus !== 0 ? `${diceBonus + bonus > 0 ? `+${diceBonus + bonus}` : diceBonus + bonus}` : ''})`;\r\n  }\r\n};\r\n\r\n/**\r\n * Calculate spell slots for a character based on class and level\r\n */\r\nexport function calculateSpellSlots(\r\n  classInfo: ClassInfo,\r\n  level: number\r\n): SpellSlots {\r\n  const emptySlots: SpellSlots = {\r\n    1: { max: 0, used: 0 },\r\n    2: { max: 0, used: 0 },\r\n    3: { max: 0, used: 0 },\r\n    4: { max: 0, used: 0 },\r\n    5: { max: 0, used: 0 },\r\n    6: { max: 0, used: 0 },\r\n    7: { max: 0, used: 0 },\r\n    8: { max: 0, used: 0 },\r\n    9: { max: 0, used: 0 },\r\n  };\r\n\r\n  if (classInfo.spellcaster === 'none' || classInfo.spellcaster === 'warlock') {\r\n    return emptySlots;\r\n  }\r\n\r\n  let slotsTable: Record<number, Record<number, number>>;\r\n\r\n  switch (classInfo.spellcaster) {\r\n    case 'full':\r\n      slotsTable = FULL_CASTER_SPELL_SLOTS;\r\n      break;\r\n    case 'half':\r\n      slotsTable = HALF_CASTER_SPELL_SLOTS;\r\n      break;\r\n    case 'third':\r\n      slotsTable = THIRD_CASTER_SPELL_SLOTS;\r\n      break;\r\n    default:\r\n      return emptySlots;\r\n  }\r\n\r\n  const levelSlots = slotsTable[level] || {};\r\n\r\n  const result = { ...emptySlots };\r\n  for (const [spellLevel, maxSlots] of Object.entries(levelSlots)) {\r\n    const level = parseInt(spellLevel) as keyof SpellSlots;\r\n    result[level] = { max: maxSlots, used: 0 };\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate warlock pact magic slots\r\n */\r\nexport function calculatePactMagic(level: number): PactMagic | undefined {\r\n  const pactData = WARLOCK_PACT_SLOTS[level];\r\n  if (!pactData) return undefined;\r\n\r\n  return {\r\n    slots: { max: pactData.slots, used: 0 },\r\n    level: pactData.level,\r\n  };\r\n}\r\n\r\n/**\r\n * Update spell slots when preserving used slots during level/class changes\r\n */\r\nexport function updateSpellSlotsPreservingUsed(\r\n  newSlots: SpellSlots,\r\n  currentSlots: SpellSlots\r\n): SpellSlots {\r\n  const result = { ...newSlots };\r\n\r\n  // Preserve used slots where possible, but don't exceed new max\r\n  for (let i = 1; i <= 9; i++) {\r\n    const level = i as keyof SpellSlots;\r\n    const currentUsed = currentSlots[level].used;\r\n    const newMax = newSlots[level].max;\r\n\r\n    result[level].used = Math.min(currentUsed, newMax);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Check if character has any spell slots\r\n */\r\nexport function hasSpellSlots(\r\n  spellSlots: SpellSlots | undefined,\r\n  pactMagic?: PactMagic\r\n): boolean {\r\n  const hasRegularSlots = spellSlots\r\n    ? Object.values(spellSlots).some(slot => slot.max > 0)\r\n    : false;\r\n  const hasPactSlots = pactMagic && pactMagic.slots.max > 0;\r\n\r\n  return hasRegularSlots || !!hasPactSlots;\r\n}\r\n\r\n/**\r\n * Calculate level from experience points\r\n */\r\nexport function calculateLevelFromXP(xp: number): number {\r\n  // Find the highest level where XP threshold is met\r\n  for (let level = 20; level >= 1; level--) {\r\n    if (xp >= XP_THRESHOLDS[level]) {\r\n      return level;\r\n    }\r\n  }\r\n  return 1; // Fallback to level 1\r\n}\r\n\r\n/**\r\n * Get XP required for a specific level\r\n */\r\nexport function getXPForLevel(level: number): number {\r\n  return XP_THRESHOLDS[Math.max(1, Math.min(20, level))] || 0;\r\n}\r\n\r\n/**\r\n * Get XP needed to reach the next level\r\n */\r\nexport function getXPToNextLevel(\r\n  currentXP: number,\r\n  currentLevel: number\r\n): number {\r\n  if (currentLevel >= 20) return 0; // Max level reached\r\n\r\n  const nextLevelXP = getXPForLevel(currentLevel + 1);\r\n  return Math.max(0, nextLevelXP - currentXP);\r\n}\r\n\r\n/**\r\n * Get XP progress percentage for current level\r\n */\r\nexport function getXPProgress(currentXP: number, currentLevel: number): number {\r\n  if (currentLevel >= 20) return 100; // Max level reached\r\n\r\n  const currentLevelXP = getXPForLevel(currentLevel);\r\n  const nextLevelXP = getXPForLevel(currentLevel + 1);\r\n  const xpInCurrentLevel = currentXP - currentLevelXP;\r\n  const xpNeededForLevel = nextLevelXP - currentLevelXP;\r\n\r\n  return Math.min(\r\n    100,\r\n    Math.max(0, (xpInCurrentLevel / xpNeededForLevel) * 100)\r\n  );\r\n}\r\n\r\n/**\r\n * Check if character should level up based on XP\r\n */\r\nexport function shouldLevelUp(\r\n  currentXP: number,\r\n  currentLevel: number\r\n): boolean {\r\n  const calculatedLevel = calculateLevelFromXP(currentXP);\r\n  return calculatedLevel > currentLevel;\r\n}\r\n\r\n// ========================================\r\n// SPELLCASTING CALCULATIONS\r\n// ========================================\r\n\r\n/**\r\n * Get the default spellcasting ability for a class\r\n */\r\nexport function getClassSpellcastingAbility(\r\n  className: string\r\n): SpellcastingAbility | null {\r\n  const normalizedClass = className.toLowerCase();\r\n\r\n  // Intelligence-based spellcasters\r\n  if (\r\n    normalizedClass.includes('wizard') ||\r\n    normalizedClass.includes('artificer') ||\r\n    normalizedClass.includes('eldritch knight') ||\r\n    normalizedClass.includes('arcane trickster')\r\n  ) {\r\n    return 'intelligence';\r\n  }\r\n\r\n  // Wisdom-based spellcasters\r\n  if (\r\n    normalizedClass.includes('cleric') ||\r\n    normalizedClass.includes('druid') ||\r\n    normalizedClass.includes('ranger')\r\n  ) {\r\n    return 'wisdom';\r\n  }\r\n\r\n  // Charisma-based spellcasters\r\n  if (\r\n    normalizedClass.includes('sorcerer') ||\r\n    normalizedClass.includes('warlock') ||\r\n    normalizedClass.includes('bard') ||\r\n    normalizedClass.includes('paladin')\r\n  ) {\r\n    return 'charisma';\r\n  }\r\n\r\n  // Non-spellcaster or unknown class\r\n  return null;\r\n}\r\n\r\n/**\r\n * Get the spellcasting ability for a character (with override support)\r\n */\r\nexport function getCharacterSpellcastingAbility(\r\n  character: CharacterState\r\n): SpellcastingAbility | null {\r\n  if (character.spellcastingStats.isAbilityOverridden) {\r\n    return character.spellcastingStats.spellcastingAbility;\r\n  }\r\n\r\n  return getClassSpellcastingAbility(character.class.name);\r\n}\r\n\r\n/**\r\n * Calculate spell attack bonus with override support\r\n * Formula: ability modifier + proficiency bonus\r\n */\r\nexport function calculateSpellAttackBonus(\r\n  character: CharacterState\r\n): number | null {\r\n  // Check for manual override first\r\n  if (character.spellcastingStats.spellAttackBonus !== undefined) {\r\n    return character.spellcastingStats.spellAttackBonus;\r\n  }\r\n\r\n  const spellcastingAbility = getCharacterSpellcastingAbility(character);\r\n  if (!spellcastingAbility) {\r\n    return null; // Not a spellcaster\r\n  }\r\n\r\n  const abilityModifier = calculateModifier(\r\n    character.abilities[spellcastingAbility]\r\n  );\r\n  const proficiencyBonus = getProficiencyBonus(character.level);\r\n\r\n  return abilityModifier + proficiencyBonus;\r\n}\r\n\r\n/**\r\n * Calculate spell save DC with override support\r\n * Formula: 8 + ability modifier + proficiency bonus\r\n */\r\nexport function calculateSpellSaveDC(character: CharacterState): number | null {\r\n  // Check for manual override first\r\n  if (character.spellcastingStats.spellSaveDC !== undefined) {\r\n    return character.spellcastingStats.spellSaveDC;\r\n  }\r\n\r\n  const spellcastingAbility = getCharacterSpellcastingAbility(character);\r\n  if (!spellcastingAbility) {\r\n    return null; // Not a spellcaster\r\n  }\r\n\r\n  const abilityModifier = calculateModifier(\r\n    character.abilities[spellcastingAbility]\r\n  );\r\n  const proficiencyBonus = getProficiencyBonus(character.level);\r\n\r\n  return 8 + abilityModifier + proficiencyBonus;\r\n}\r\n\r\n/**\r\n * Check if a character is a spellcaster\r\n */\r\nexport function isSpellcaster(character: CharacterState): boolean {\r\n  return (\r\n    getCharacterSpellcastingAbility(character) !== null ||\r\n    character.class.spellcaster !== 'none'\r\n  );\r\n}\r\n\r\n/**\r\n * Get spellcasting ability modifier\r\n */\r\nexport function getSpellcastingAbilityModifier(\r\n  character: CharacterState\r\n): number | null {\r\n  const spellcastingAbility = getCharacterSpellcastingAbility(character);\r\n  if (!spellcastingAbility) {\r\n    return null;\r\n  }\r\n\r\n  return calculateModifier(character.abilities[spellcastingAbility]);\r\n}\r\n\r\n/**\r\n * Format spell attack bonus for display\r\n */\r\nexport function getSpellAttackString(character: CharacterState): string {\r\n  const attackBonus = calculateSpellAttackBonus(character);\r\n  if (attackBonus === null) {\r\n    return '—';\r\n  }\r\n\r\n  return attackBonus >= 0 ? `+${attackBonus}` : `${attackBonus}`;\r\n}\r\n\r\n/**\r\n * Format spell save DC for display\r\n */\r\nexport function getSpellSaveDCString(character: CharacterState): string {\r\n  const saveDC = calculateSpellSaveDC(character);\r\n  if (saveDC === null) {\r\n    return '—';\r\n  }\r\n\r\n  return `${saveDC}`;\r\n}\r\n\r\n/**\r\n * Calculate effective max uses for a trackable trait\r\n * Takes into account proficiency bonus scaling if enabled\r\n */\r\nexport function calculateTraitMaxUses(\r\n  trait: TrackableTrait,\r\n  characterLevel: number\r\n): number {\r\n  if (!trait.scaleWithProficiency) {\r\n    return trait.maxUses;\r\n  }\r\n\r\n  const proficiencyBonus = getProficiencyBonus(characterLevel);\r\n  const multiplier = trait.proficiencyMultiplier || 1;\r\n\r\n  return Math.max(1, Math.floor(proficiencyBonus * multiplier));\r\n}\r\n\r\n// ===== MULTICLASS CALCULATION FUNCTIONS =====\r\n\r\n/**\r\n * Calculate spell slots for multiclass characters\r\n * This is the main function that should be used for all characters (single or multiclass)\r\n */\r\nexport function calculateCharacterSpellSlots(character: CharacterState): SpellSlots {\r\n  // If character has multiclass data, use multiclass calculation\r\n  if (character.classes && character.classes.length > 0) {\r\n    return calculateMulticlassSpellSlots(character.classes);\r\n  }\r\n  \r\n  // Fallback to single class calculation\r\n  return calculateSpellSlots(character.class, character.level);\r\n}\r\n\r\n/**\r\n * Calculate spell slots for multiclass characters based on combined caster levels\r\n */\r\nexport function calculateMulticlassSpellSlots(classes: MulticlassInfo[]): SpellSlots {\r\n  let casterLevel = 0;\r\n  \r\n  for (const classInfo of classes) {\r\n    switch (classInfo.spellcaster) {\r\n      case 'full':\r\n        casterLevel += classInfo.level;\r\n        break;\r\n      case 'half':\r\n        casterLevel += Math.floor(classInfo.level / 2);\r\n        break;\r\n      case 'third':\r\n        casterLevel += Math.floor(classInfo.level / 3);\r\n        break;\r\n      case 'warlock':\r\n        // Warlocks don't contribute to multiclass spell slots\r\n        break;\r\n      case 'none':\r\n      default:\r\n        // Non-casters don't contribute\r\n        break;\r\n    }\r\n  }\r\n\r\n  // If no caster levels, return empty slots\r\n  if (casterLevel === 0) {\r\n    return {\r\n      1: { max: 0, used: 0 },\r\n      2: { max: 0, used: 0 },\r\n      3: { max: 0, used: 0 },\r\n      4: { max: 0, used: 0 },\r\n      5: { max: 0, used: 0 },\r\n      6: { max: 0, used: 0 },\r\n      7: { max: 0, used: 0 },\r\n      8: { max: 0, used: 0 },\r\n      9: { max: 0, used: 0 },\r\n    };\r\n  }\r\n\r\n  // Use full caster progression table for the combined caster level\r\n  const levelSlots = FULL_CASTER_SPELL_SLOTS[casterLevel] || {};\r\n  \r\n  const result: SpellSlots = {\r\n    1: { max: 0, used: 0 },\r\n    2: { max: 0, used: 0 },\r\n    3: { max: 0, used: 0 },\r\n    4: { max: 0, used: 0 },\r\n    5: { max: 0, used: 0 },\r\n    6: { max: 0, used: 0 },\r\n    7: { max: 0, used: 0 },\r\n    8: { max: 0, used: 0 },\r\n    9: { max: 0, used: 0 },\r\n  };\r\n\r\n  for (const [spellLevel, maxSlots] of Object.entries(levelSlots)) {\r\n    const level = parseInt(spellLevel) as keyof SpellSlots;\r\n    result[level] = { max: maxSlots, used: 0 };\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate pact magic for multiclass characters (only considers warlock levels)\r\n */\r\nexport function calculateCharacterPactMagic(character: CharacterState): PactMagic | undefined {\r\n  // If character has multiclass data, find warlock levels\r\n  if (character.classes && character.classes.length > 0) {\r\n    const warlockClass = character.classes.find(cls => cls.spellcaster === 'warlock');\r\n    if (warlockClass) {\r\n      return calculatePactMagic(warlockClass.level);\r\n    }\r\n    return undefined;\r\n  }\r\n  \r\n  // Fallback to single class calculation\r\n  if (character.class.spellcaster === 'warlock') {\r\n    return calculatePactMagic(character.level);\r\n  }\r\n  \r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Calculate hit dice pools for multiclass characters\r\n */\r\nexport function calculateCharacterHitDicePools(character: CharacterState): HitDicePools {\r\n  // If character has multiclass data, calculate from classes\r\n  if (character.classes && character.classes.length > 0) {\r\n    const hitDicePools: HitDicePools = {};\r\n\r\n    for (const classInfo of character.classes) {\r\n      const dieType = `d${classInfo.hitDie}`;\r\n      if (!hitDicePools[dieType]) {\r\n        hitDicePools[dieType] = { max: 0, used: 0 };\r\n      }\r\n      hitDicePools[dieType].max += classInfo.level;\r\n    }\r\n\r\n    return hitDicePools;\r\n  }\r\n  \r\n  // Fallback to single class calculation\r\n  const dieType = `d${character.class.hitDie}`;\r\n  return {\r\n    [dieType]: {\r\n      max: character.level,\r\n      used: 0,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Get the total character level (works for both single and multiclass)\r\n */\r\nexport function getCharacterTotalLevel(character: CharacterState): number {\r\n  if (character.totalLevel !== undefined) {\r\n    return character.totalLevel;\r\n  }\r\n  \r\n  if (character.classes && character.classes.length > 0) {\r\n    return character.classes.reduce((total, cls) => total + cls.level, 0);\r\n  }\r\n  \r\n  return character.level || 1;\r\n}\r\n\r\n/**\r\n * Check if character has any spellcasting ability\r\n */\r\nexport function hasSpellcasting(character: CharacterState): boolean {\r\n  if (character.classes && character.classes.length > 0) {\r\n    return character.classes.some(cls => \r\n      cls.spellcaster && cls.spellcaster !== 'none'\r\n    );\r\n  }\r\n  \r\n  return character.class.spellcaster !== 'none' && character.class.spellcaster !== undefined;\r\n}\r\n\r\n/**\r\n * Check if character has warlock levels\r\n */\r\nexport function hasWarlockLevels(character: CharacterState): boolean {\r\n  if (character.classes && character.classes.length > 0) {\r\n    return character.classes.some(cls => cls.spellcaster === 'warlock');\r\n  }\r\n  \r\n  return character.class.spellcaster === 'warlock';\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1766, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/multiclass.ts"],"sourcesContent":["import {\r\n  CharacterState,\r\n  ClassInfo,\r\n  MulticlassInfo,\r\n  MulticlassValidation,\r\n  HitDicePools,\r\n  SpellSlots,\r\n  CharacterAbilities,\r\n} from '@/types/character';\r\nimport { ProcessedClass } from '@/types/classes';\r\nimport { calculateSpellSlots } from './calculations';\r\n\r\n/**\r\n * Convert a single-class character to multiclass format\r\n */\r\nexport function migrateToMulticlass(character: CharacterState): CharacterState {\r\n  // If already has multiclass data, return as-is\r\n  if (character.classes && character.classes.length > 0) {\r\n    return character;\r\n  }\r\n\r\n  // Convert single class to multiclass format\r\n  const singleClass: MulticlassInfo = {\r\n    className: character.class?.name || '',\r\n    level: character.level || 1,\r\n    isCustom: character.class?.isCustom || false,\r\n    spellcaster: character.class?.spellcaster,\r\n    hitDie: character.class?.hitDie || 8,\r\n  };\r\n\r\n  // Calculate hit dice pools from single class\r\n  const hitDicePools: HitDicePools = {};\r\n  const dieType = `d${singleClass.hitDie}`;\r\n  hitDicePools[dieType] = {\r\n    max: singleClass.level,\r\n    used: 0, // Start with all hit dice available\r\n  };\r\n\r\n  return {\r\n    ...character,\r\n    classes: [singleClass],\r\n    totalLevel: character.level || 1,\r\n    hitDicePools,\r\n    // Keep old fields for backwards compatibility\r\n    class: character.class,\r\n    level: character.level,\r\n  };\r\n}\r\n\r\n/**\r\n * Check if a character is multiclassed\r\n */\r\nexport function isMulticlassed(character: CharacterState): boolean {\r\n  return (character.classes?.length || 0) > 1;\r\n}\r\n\r\n/**\r\n * Calculate hit dice pools from multiclass data\r\n */\r\nexport function calculateHitDicePools(classes: MulticlassInfo[], existingPools?: HitDicePools): HitDicePools {\r\n  const hitDicePools: HitDicePools = {};\r\n  \r\n  // Calculate max dice for each die type\r\n  classes.forEach(cls => {\r\n    const dieType = `d${cls.hitDie}`;\r\n    if (!hitDicePools[dieType]) {\r\n      hitDicePools[dieType] = { max: 0, used: 0 };\r\n    }\r\n    hitDicePools[dieType].max += cls.level;\r\n  });\r\n  \r\n  // Preserve used dice from existing pools, but cap at new max\r\n  if (existingPools) {\r\n    Object.keys(hitDicePools).forEach(dieType => {\r\n      if (existingPools[dieType]) {\r\n        hitDicePools[dieType].used = Math.min(\r\n          existingPools[dieType].used,\r\n          hitDicePools[dieType].max\r\n        );\r\n      }\r\n    });\r\n  }\r\n  \r\n  return hitDicePools;\r\n}\r\n\r\n/**\r\n * Get the total character level from multiclass data\r\n */\r\nexport function getTotalLevel(character: CharacterState): number {\r\n  if (character.totalLevel !== undefined) {\r\n    return character.totalLevel;\r\n  }\r\n  \r\n  if (character.classes && character.classes.length > 0) {\r\n    return character.classes.reduce((total, cls) => total + cls.level, 0);\r\n  }\r\n  \r\n  return character.level || 1;\r\n}\r\n\r\n/**\r\n * Get the primary class (highest level class, or first if tied)\r\n */\r\nexport function getPrimaryClass(character: CharacterState): MulticlassInfo | null {\r\n  if (!character.classes || character.classes.length === 0) {\r\n    // Fallback to single class format\r\n    if (character.class) {\r\n      return {\r\n        className: character.class.name,\r\n        level: character.level || 1,\r\n        isCustom: character.class.isCustom,\r\n        spellcaster: character.class.spellcaster,\r\n        hitDie: character.class.hitDie,\r\n      };\r\n    }\r\n    return null;\r\n  }\r\n\r\n  return character.classes.reduce((primary, current) => \r\n    current.level > primary.level ? current : primary\r\n  );\r\n}\r\n\r\n/**\r\n * Calculate spell slots for multiclass characters\r\n */\r\nexport function calculateMulticlassSpellSlots(classes: MulticlassInfo[]): SpellSlots {\r\n  let casterLevel = 0;\r\n  \r\n  for (const classInfo of classes) {\r\n    switch (classInfo.spellcaster) {\r\n      case 'full':\r\n        casterLevel += classInfo.level;\r\n        break;\r\n      case 'half':\r\n        casterLevel += Math.floor(classInfo.level / 2);\r\n        break;\r\n      case 'third':\r\n        casterLevel += Math.floor(classInfo.level / 3);\r\n        break;\r\n      case 'warlock':\r\n        // Warlocks don't contribute to multiclass spell slots\r\n        break;\r\n      case 'none':\r\n      default:\r\n        // Non-casters don't contribute\r\n        break;\r\n    }\r\n  }\r\n\r\n  // Use the existing spell slot calculation with the combined caster level\r\n  const dummyClassInfo: ClassInfo = {\r\n    name: 'Multiclass',\r\n    isCustom: false,\r\n    spellcaster: 'full',\r\n    hitDie: 8,\r\n  };\r\n\r\n  return calculateSpellSlots(dummyClassInfo, casterLevel);\r\n}\r\n\r\n\r\n// Hardcoded multiclassing requirements as fallback\r\nconst MULTICLASS_REQUIREMENTS: Record<string, Record<string, number>> = {\r\n  'Barbarian': { strength: 13 },\r\n  'Bard': { charisma: 13 },\r\n  'Cleric': { wisdom: 13 },\r\n  'Druid': { wisdom: 13 },\r\n  'Fighter': { strength: 13 }, // Note: Fighter can also use DEX 13, but we'll use STR as primary\r\n  'Monk': { dexterity: 13, wisdom: 13 },\r\n  'Paladin': { strength: 13, charisma: 13 },\r\n  'Ranger': { dexterity: 13, wisdom: 13 },\r\n  'Rogue': { dexterity: 13 },\r\n  'Sorcerer': { charisma: 13 },\r\n  'Warlock': { charisma: 13 },\r\n  'Wizard': { intelligence: 13 },\r\n  'Artificer': { intelligence: 13 },\r\n  'Blood Hunter': { strength: 13 }, // Assuming STR for Blood Hunter\r\n};\r\n\r\n/**\r\n * Validate multiclassing requirements\r\n */\r\nexport function validateMulticlassRequirements(\r\n  currentClasses: MulticlassInfo[],\r\n  newClassName: string,\r\n  abilities: CharacterAbilities,\r\n  classData?: ProcessedClass[]\r\n): MulticlassValidation {\r\n  const errors: string[] = [];\r\n  const warnings: string[] = [];\r\n\r\n  // Try to get requirements from API data first, then fallback to hardcoded\r\n  let newClassRequirements: Record<string, number> = {};\r\n  \r\n  const newClassData = classData?.find(cls => cls.name === newClassName);\r\n  if (newClassData?.multiclassing?.requirements && Object.keys(newClassData.multiclassing.requirements).length > 0) {\r\n    newClassRequirements = newClassData.multiclassing.requirements;\r\n  } else {\r\n    newClassRequirements = MULTICLASS_REQUIREMENTS[newClassName] || {};\r\n    \r\n    if (Object.keys(newClassRequirements).length === 0) {\r\n      errors.push(`Multiclassing requirements not found for ${newClassName}`);\r\n      return { valid: false, errors, warnings };\r\n    }\r\n  }\r\n\r\n  // Check requirements for the new class\r\n  for (const [ability, requiredScore] of Object.entries(newClassRequirements)) {\r\n    const abilityScore = abilities[ability as keyof CharacterAbilities];\r\n    if (abilityScore < requiredScore) {\r\n      errors.push(\r\n        `${newClassName} requires ${ability.charAt(0).toUpperCase() + ability.slice(1)} ${requiredScore} (you have ${abilityScore})`\r\n      );\r\n    }\r\n  }\r\n\r\n  // Check requirements for existing classes (must maintain them)\r\n  for (const existingClass of currentClasses) {\r\n    let existingClassRequirements: Record<string, number> = {};\r\n    \r\n    const existingClassData = classData?.find(cls => cls.name === existingClass.className);\r\n    if (existingClassData?.multiclassing?.requirements && Object.keys(existingClassData.multiclassing.requirements).length > 0) {\r\n      existingClassRequirements = existingClassData.multiclassing.requirements;\r\n    } else {\r\n      existingClassRequirements = MULTICLASS_REQUIREMENTS[existingClass.className] || {};\r\n    }\r\n    \r\n    for (const [ability, requiredScore] of Object.entries(existingClassRequirements)) {\r\n      const abilityScore = abilities[ability as keyof CharacterAbilities];\r\n      if (abilityScore < requiredScore) {\r\n        errors.push(\r\n          `You must maintain ${ability.charAt(0).toUpperCase() + ability.slice(1)} ${requiredScore} for ${existingClass.className} (you have ${abilityScore})`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check for level 20 limit\r\n  const totalLevel = currentClasses.reduce((sum, cls) => sum + cls.level, 0) + 1; // +1 for new level\r\n  if (totalLevel > 20) {\r\n    errors.push('Total character level cannot exceed 20');\r\n  }\r\n\r\n  // Add warnings for common multiclassing considerations\r\n  if (currentClasses.length === 0) {\r\n    warnings.push('Consider taking your first class to level 2 before multiclassing to gain important features');\r\n  }\r\n  const hasSpellcaster = currentClasses.some(cls => cls.spellcaster && cls.spellcaster !== 'none');\r\n  const newClassIsSpellcaster = newClassData?.spellcasting?.type && newClassData.spellcasting.type !== 'none';\r\n  \r\n  if (hasSpellcaster && newClassIsSpellcaster) {\r\n    warnings.push('Multiclassing spellcasters have complex spell slot and spell preparation rules');\r\n  }\r\n\r\n  return {\r\n    valid: errors.length === 0,\r\n    errors,\r\n    warnings: warnings.length > 0 ? warnings : undefined,\r\n  };\r\n}\r\n\r\n/**\r\n * Add a class level to a character\r\n */\r\nexport function addClassLevel(\r\n  character: CharacterState,\r\n  className: string,\r\n  isCustom: boolean = false,\r\n  spellcaster?: 'full' | 'half' | 'third' | 'warlock' | 'none',\r\n  hitDie: number = 8,\r\n  subclass?: string\r\n): CharacterState {\r\n  // Ensure character has multiclass structure\r\n  const migratedCharacter = migrateToMulticlass(character);\r\n  const classes = [...(migratedCharacter.classes || [])];\r\n\r\n  // Find existing class or create new one\r\n  const existingClassIndex = classes.findIndex(cls => cls.className === className);\r\n  \r\n  if (existingClassIndex >= 0) {\r\n    // Level up existing class\r\n    classes[existingClassIndex] = {\r\n      ...classes[existingClassIndex],\r\n      level: classes[existingClassIndex].level + 1,\r\n      subclass: subclass || classes[existingClassIndex].subclass,\r\n    };\r\n  } else {\r\n    // Add new class\r\n    classes.push({\r\n      className,\r\n      level: 1,\r\n      isCustom,\r\n      spellcaster,\r\n      hitDie,\r\n      subclass,\r\n    });\r\n  }\r\n\r\n  const totalLevel = classes.reduce((sum, cls) => sum + cls.level, 0);\r\n  const hitDicePools = calculateHitDicePools(classes);\r\n\r\n  // Update backwards compatibility fields\r\n  const primaryClass = classes.reduce((primary, current) => \r\n    current.level > primary.level ? current : primary\r\n  );\r\n\r\n  const compatibilityClass: ClassInfo = {\r\n    name: primaryClass.className,\r\n    isCustom: primaryClass.isCustom,\r\n    spellcaster: primaryClass.spellcaster,\r\n    hitDie: primaryClass.hitDie,\r\n  };\r\n\r\n  return {\r\n    ...migratedCharacter,\r\n    classes,\r\n    totalLevel,\r\n    hitDicePools,\r\n    // Update backwards compatibility fields\r\n    class: compatibilityClass,\r\n    level: totalLevel,\r\n  };\r\n}\r\n\r\n/**\r\n * Remove a class level from a character\r\n */\r\nexport function removeClassLevel(\r\n  character: CharacterState,\r\n  className: string\r\n): CharacterState {\r\n  const migratedCharacter = migrateToMulticlass(character);\r\n  const classes = [...(migratedCharacter.classes || [])];\r\n\r\n  const classIndex = classes.findIndex(cls => cls.className === className);\r\n  if (classIndex === -1) {\r\n    return migratedCharacter; // Class not found\r\n  }\r\n\r\n  if (classes[classIndex].level > 1) {\r\n    // Reduce level by 1\r\n    classes[classIndex] = {\r\n      ...classes[classIndex],\r\n      level: classes[classIndex].level - 1,\r\n    };\r\n  } else {\r\n    // Remove class entirely\r\n    classes.splice(classIndex, 1);\r\n  }\r\n\r\n  // If no classes left, this shouldn't happen but handle gracefully\r\n  if (classes.length === 0) {\r\n    return migratedCharacter;\r\n  }\r\n\r\n  const totalLevel = classes.reduce((sum, cls) => sum + cls.level, 0);\r\n  const hitDicePools = calculateHitDicePools(classes);\r\n\r\n  // Update backwards compatibility fields\r\n  const primaryClass = classes.reduce((primary, current) => \r\n    current.level > primary.level ? current : primary\r\n  );\r\n\r\n  const compatibilityClass: ClassInfo = {\r\n    name: primaryClass.className,\r\n    isCustom: primaryClass.isCustom,\r\n    spellcaster: primaryClass.spellcaster,\r\n    hitDie: primaryClass.hitDie,\r\n  };\r\n\r\n  return {\r\n    ...migratedCharacter,\r\n    classes,\r\n    totalLevel,\r\n    hitDicePools,\r\n    // Update backwards compatibility fields\r\n    class: compatibilityClass,\r\n    level: totalLevel,\r\n  };\r\n}\r\n\r\n/**\r\n * Get a formatted display string for multiclass characters\r\n */\r\nexport function getClassDisplayString(character: CharacterState): string {\r\n  if (!character.classes || character.classes.length === 0) {\r\n    // Fallback to single class format\r\n    return `${character.class?.name || 'Unknown'} ${character.level || 1}`;\r\n  }\r\n\r\n  if (character.classes.length === 1) {\r\n    const cls = character.classes[0];\r\n    return `${cls.className} ${cls.level}`;\r\n  }\r\n\r\n  // Sort classes by level (descending) for display\r\n  const sortedClasses = [...character.classes].sort((a, b) => b.level - a.level);\r\n  const classStrings = sortedClasses.map(cls => `${cls.className} ${cls.level}`);\r\n  const totalLevel = getTotalLevel(character);\r\n  \r\n  return `${classStrings.join(' / ')} (Level ${totalLevel})`;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2122, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/hpCalculations.ts"],"sourcesContent":["import { calculateModifier } from './calculations';\r\nimport { CLASS_HIT_DICE } from './constants';\r\nimport { HitPoints, DeathSavingThrows, ClassInfo } from '@/types/character';\r\n\r\n/**\r\n * Calculate maximum HP for a character using D&D 5e rules\r\n * Level 1: Max hit die + CON modifier\r\n * Subsequent levels: Average of hit die (rounded up) + CON modifier per level\r\n */\r\nexport function calculateMaxHP(\r\n  classInfo: ClassInfo,\r\n  level: number,\r\n  constitutionScore: number,\r\n  manualOverride?: number\r\n): number {\r\n  if (manualOverride !== undefined) {\r\n    return manualOverride;\r\n  }\r\n\r\n  const conModifier = calculateModifier(constitutionScore);\r\n  const hitDie = classInfo.hitDie;\r\n\r\n  // Level 1: Full hit die + CON modifier\r\n  let maxHP = hitDie + conModifier;\r\n\r\n  // Subsequent levels: Average hit die (rounded up) + CON modifier\r\n  if (level > 1) {\r\n    const averageHitDieRoll = Math.floor(hitDie / 2) + 1; // (hitDie + 1) / 2 rounded up\r\n    maxHP += (level - 1) * (averageHitDieRoll + conModifier);\r\n  }\r\n\r\n  // Minimum 1 HP per level\r\n  return Math.max(maxHP, level);\r\n}\r\n\r\n/**\r\n * Get hit die for a class name, with fallback for custom classes\r\n */\r\nexport function getClassHitDie(\r\n  className: string,\r\n  customHitDie?: number\r\n): number {\r\n  if (customHitDie) {\r\n    return customHitDie;\r\n  }\r\n\r\n  return CLASS_HIT_DICE[className] || 8; // Default to d8 for unknown classes\r\n}\r\n\r\n/**\r\n * Apply damage following D&D 5e rules:\r\n * 1. Damage hits temporary HP first\r\n * 2. Excess damage carries over to current HP\r\n * 3. If current HP reaches 0, trigger death saves\r\n * 4. If excess damage after reaching 0 HP >= max HP, instant death (massive damage)\r\n */\r\nexport function applyDamage(hitPoints: HitPoints, damage: number): HitPoints {\r\n  if (damage <= 0) return hitPoints;\r\n\r\n  let remainingDamage = damage;\r\n  let newTempHP = hitPoints.temporary;\r\n  let newCurrentHP = hitPoints.current;\r\n  let deathSaves = hitPoints.deathSaves;\r\n\r\n  // First, damage temporary HP\r\n  if (newTempHP > 0) {\r\n    const tempDamage = Math.min(remainingDamage, newTempHP);\r\n    newTempHP -= tempDamage;\r\n    remainingDamage -= tempDamage;\r\n  }\r\n\r\n  // Then damage current HP\r\n  if (remainingDamage > 0) {\r\n    // Calculate how much damage it takes to reach 0 HP\r\n    const damageToZero = Math.min(remainingDamage, newCurrentHP);\r\n    newCurrentHP -= damageToZero;\r\n\r\n    // If we hit 0 HP or below\r\n    if (newCurrentHP <= 0) {\r\n      newCurrentHP = 0;\r\n\r\n      // Calculate excess damage after reaching 0 HP (massive damage calculation)\r\n      const excessDamage = remainingDamage - damageToZero;\r\n\r\n      // Check for massive damage (excess damage >= max HP)\r\n      if (excessDamage >= hitPoints.max) {\r\n        // Instant death from massive damage\r\n        deathSaves = {\r\n          successes: 0,\r\n          failures: 3,\r\n          isStabilized: false,\r\n        };\r\n      } else if (!deathSaves) {\r\n        // Start death saving throws (unconscious but not dead)\r\n        deathSaves = {\r\n          successes: 0,\r\n          failures: 0,\r\n          isStabilized: false,\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...hitPoints,\r\n    current: newCurrentHP,\r\n    temporary: newTempHP,\r\n    deathSaves,\r\n  };\r\n}\r\n\r\n/**\r\n * Apply healing following D&D 5e rules:\r\n * 1. Healing only affects current HP, not temporary HP\r\n * 2. Cannot exceed maximum HP\r\n * 3. Any healing removes death save state\r\n */\r\nexport function applyHealing(hitPoints: HitPoints, healing: number): HitPoints {\r\n  if (healing <= 0) return hitPoints;\r\n\r\n  const newCurrentHP = Math.min(hitPoints.current + healing, hitPoints.max);\r\n  let deathSaves = hitPoints.deathSaves;\r\n\r\n  // Any healing while at 0 HP removes death save state\r\n  if (hitPoints.current === 0 && healing > 0) {\r\n    deathSaves = undefined;\r\n  }\r\n\r\n  return {\r\n    ...hitPoints,\r\n    current: newCurrentHP,\r\n    deathSaves,\r\n  };\r\n}\r\n\r\n/**\r\n * Add temporary HP following D&D 5e rules:\r\n * 1. Temporary HP doesn't stack - take the higher value\r\n * 2. Temporary HP doesn't affect current or max HP\r\n */\r\nexport function addTemporaryHP(\r\n  hitPoints: HitPoints,\r\n  tempHP: number\r\n): HitPoints {\r\n  if (tempHP <= 0) return hitPoints;\r\n\r\n  return {\r\n    ...hitPoints,\r\n    temporary: Math.max(hitPoints.temporary, tempHP),\r\n  };\r\n}\r\n\r\n/**\r\n * Make a death saving throw\r\n * @param isSuccess - whether the death save was successful (d20 >= 10)\r\n * @param isCritical - whether it was a critical success (natural 20)\r\n */\r\nexport function makeDeathSave(\r\n  hitPoints: HitPoints,\r\n  isSuccess: boolean,\r\n  isCritical: boolean = false\r\n): HitPoints {\r\n  if (!hitPoints.deathSaves) {\r\n    return hitPoints;\r\n  }\r\n\r\n  let newDeathSaves: DeathSavingThrows | undefined = {\r\n    ...hitPoints.deathSaves,\r\n  };\r\n  let newCurrentHP = hitPoints.current;\r\n\r\n  if (isSuccess) {\r\n    if (isCritical) {\r\n      // Natural 20: regain 1 HP and become conscious\r\n      newCurrentHP = 1;\r\n      newDeathSaves = undefined; // Remove death saves\r\n    } else {\r\n      // Regular success\r\n      newDeathSaves.successes = Math.min(newDeathSaves.successes + 1, 3);\r\n\r\n      // 3 successes = stabilized\r\n      if (newDeathSaves.successes >= 3) {\r\n        newDeathSaves.isStabilized = true;\r\n      }\r\n    }\r\n  } else {\r\n    // Failure\r\n    newDeathSaves.failures = Math.min(newDeathSaves.failures + 1, 3);\r\n  }\r\n\r\n  return {\r\n    ...hitPoints,\r\n    current: newCurrentHP,\r\n    deathSaves: newDeathSaves,\r\n  };\r\n}\r\n\r\n/**\r\n * Reset death saving throws (used when character is healed or stabilized)\r\n */\r\nexport function resetDeathSaves(hitPoints: HitPoints): HitPoints {\r\n  return {\r\n    ...hitPoints,\r\n    deathSaves: undefined,\r\n  };\r\n}\r\n\r\n/**\r\n * Check if character is dying (unconscious and making death saves)\r\n */\r\nexport function isDying(hitPoints: HitPoints): boolean {\r\n  return (\r\n    hitPoints.current === 0 &&\r\n    !!hitPoints.deathSaves &&\r\n    !hitPoints.deathSaves.isStabilized\r\n  );\r\n}\r\n\r\n/**\r\n * Check if character is dead (3 failed death saves)\r\n */\r\nexport function isDead(hitPoints: HitPoints): boolean {\r\n  return !!hitPoints.deathSaves && hitPoints.deathSaves.failures >= 3;\r\n}\r\n\r\n/**\r\n * Check if character is stabilized (0 HP but not dying)\r\n */\r\nexport function isStabilized(hitPoints: HitPoints): boolean {\r\n  return (\r\n    hitPoints.current === 0 &&\r\n    !!hitPoints.deathSaves &&\r\n    hitPoints.deathSaves.isStabilized\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2288, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/cn.ts"],"sourcesContent":["import { type ClassValue, clsx } from 'clsx';\r\nimport { twMerge } from 'tailwind-merge';\r\n\r\nexport function cn(...inputs: ClassValue[]) {\r\n  return twMerge(clsx(inputs));\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,sKAAO,EAAC,IAAA,6IAAI,EAAC;AACtB","debugId":null}},
    {"offset": {"line": 2303, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/currency.ts"],"sourcesContent":["// Currency conversion utility functions\r\n\r\nexport function formatCurrencyFromCopper(totalCopper: number): string {\r\n  if (!totalCopper || totalCopper <= 0) return '0 cp';\r\n\r\n  const gold = Math.floor(totalCopper / 100);\r\n  const remainingAfterGold = totalCopper % 100;\r\n\r\n  const silver = Math.floor(remainingAfterGold / 10);\r\n  const copper = remainingAfterGold % 10;\r\n\r\n  const parts = [];\r\n\r\n  if (gold > 0) parts.push(`${gold} gp`);\r\n  if (silver > 0) parts.push(`${silver} sp`);\r\n  if (copper > 0) parts.push(`${copper} cp`);\r\n\r\n  return parts.join(', ');\r\n}\r\n\r\nexport function formatCurrencyFromCopperShort(totalCopper: number): string {\r\n  if (!totalCopper || totalCopper <= 0) return '0cp';\r\n\r\n  const gold = Math.floor(totalCopper / 100);\r\n  const remainingAfterGold = totalCopper % 100;\r\n\r\n  const silver = Math.floor(remainingAfterGold / 10);\r\n  const copper = remainingAfterGold % 10;\r\n\r\n  const parts = [];\r\n\r\n  if (gold > 0) parts.push(`${gold}g`);\r\n  if (silver > 0) parts.push(`${silver}s`);\r\n  if (copper > 0) parts.push(`${copper}c`);\r\n\r\n  return parts.join(' ');\r\n}\r\n"],"names":[],"mappings":"AAAA,wCAAwC;;;;;;;AAEjC,SAAS,yBAAyB,WAAmB;IAC1D,IAAI,CAAC,eAAe,eAAe,GAAG,OAAO;IAE7C,MAAM,OAAO,KAAK,KAAK,CAAC,cAAc;IACtC,MAAM,qBAAqB,cAAc;IAEzC,MAAM,SAAS,KAAK,KAAK,CAAC,qBAAqB;IAC/C,MAAM,SAAS,qBAAqB;IAEpC,MAAM,QAAQ,EAAE;IAEhB,IAAI,OAAO,GAAG,MAAM,IAAI,CAAC,GAAG,KAAK,GAAG,CAAC;IACrC,IAAI,SAAS,GAAG,MAAM,IAAI,CAAC,GAAG,OAAO,GAAG,CAAC;IACzC,IAAI,SAAS,GAAG,MAAM,IAAI,CAAC,GAAG,OAAO,GAAG,CAAC;IAEzC,OAAO,MAAM,IAAI,CAAC;AACpB;AAEO,SAAS,8BAA8B,WAAmB;IAC/D,IAAI,CAAC,eAAe,eAAe,GAAG,OAAO;IAE7C,MAAM,OAAO,KAAK,KAAK,CAAC,cAAc;IACtC,MAAM,qBAAqB,cAAc;IAEzC,MAAM,SAAS,KAAK,KAAK,CAAC,qBAAqB;IAC/C,MAAM,SAAS,qBAAqB;IAEpC,MAAM,QAAQ,EAAE;IAEhB,IAAI,OAAO,GAAG,MAAM,IAAI,CAAC,GAAG,KAAK,CAAC,CAAC;IACnC,IAAI,SAAS,GAAG,MAAM,IAAI,CAAC,GAAG,OAAO,CAAC,CAAC;IACvC,IAAI,SAAS,GAAG,MAAM,IAAI,CAAC,GAAG,OAAO,CAAC,CAAC;IAEvC,OAAO,MAAM,IAAI,CAAC;AACpB","debugId":null}},
    {"offset": {"line": 2338, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/fileOperations.ts"],"sourcesContent":["import { CharacterExport } from '@/types/character';\r\n\r\n/**\r\n * Export character data as a JSON file download\r\n */\r\nexport const exportCharacterToFile = (exportData: CharacterExport): void => {\r\n  const characterName = exportData.character.name || 'character';\r\n  const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format\r\n  const filename = `${characterName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${timestamp}.json`;\r\n\r\n  const dataStr = JSON.stringify(exportData, null, 2);\r\n  const dataUri =\r\n    'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);\r\n\r\n  const linkElement = document.createElement('a');\r\n  linkElement.setAttribute('href', dataUri);\r\n  linkElement.setAttribute('download', filename);\r\n  linkElement.style.display = 'none';\r\n\r\n  document.body.appendChild(linkElement);\r\n  linkElement.click();\r\n  document.body.removeChild(linkElement);\r\n};\r\n\r\n/**\r\n * Import character data from a file\r\n */\r\nexport const importCharacterFromFile = (): Promise<CharacterExport> => {\r\n  return new Promise((resolve, reject) => {\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.json';\r\n    input.style.display = 'none';\r\n\r\n    input.onchange = async event => {\r\n      const file = (event.target as HTMLInputElement).files?.[0];\r\n\r\n      if (!file) {\r\n        reject(new Error('No file selected'));\r\n        return;\r\n      }\r\n\r\n      if (!file.name.toLowerCase().endsWith('.json')) {\r\n        reject(new Error('Please select a valid JSON file'));\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const text = await file.text();\r\n        const data = JSON.parse(text);\r\n\r\n        // Basic validation\r\n        if (!data.character || typeof data.character !== 'object') {\r\n          reject(new Error('Invalid character file format'));\r\n          return;\r\n        }\r\n\r\n        // Check for required character properties\r\n        const requiredProps = ['name', 'abilities', 'skills', 'savingThrows'];\r\n        for (const prop of requiredProps) {\r\n          if (!(prop in data.character)) {\r\n            reject(new Error(`Missing required character property: ${prop}`));\r\n            return;\r\n          }\r\n        }\r\n\r\n        resolve(data as CharacterExport);\r\n      } catch (error) {\r\n        if (error instanceof SyntaxError) {\r\n          reject(new Error('Invalid JSON file format'));\r\n        } else {\r\n          reject(error);\r\n        }\r\n      } finally {\r\n        document.body.removeChild(input);\r\n      }\r\n    };\r\n\r\n    input.oncancel = () => {\r\n      document.body.removeChild(input);\r\n      reject(new Error('File selection cancelled'));\r\n    };\r\n\r\n    document.body.appendChild(input);\r\n    input.click();\r\n  });\r\n};\r\n\r\n/**\r\n * Copy character data to clipboard as JSON\r\n */\r\nexport const copyCharacterToClipboard = async (\r\n  exportData: CharacterExport\r\n): Promise<void> => {\r\n  const dataStr = JSON.stringify(exportData, null, 2);\r\n\r\n  if (navigator.clipboard && window.isSecureContext) {\r\n    await navigator.clipboard.writeText(dataStr);\r\n  } else {\r\n    // Fallback for older browsers or non-secure contexts\r\n    const textArea = document.createElement('textarea');\r\n    textArea.value = dataStr;\r\n    textArea.style.position = 'fixed';\r\n    textArea.style.left = '-999999px';\r\n    textArea.style.top = '-999999px';\r\n\r\n    document.body.appendChild(textArea);\r\n    textArea.focus();\r\n    textArea.select();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      if (document.execCommand('copy')) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error('Failed to copy to clipboard'));\r\n      }\r\n      document.body.removeChild(textArea);\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Paste character data from clipboard\r\n */\r\nexport const pasteCharacterFromClipboard =\r\n  async (): Promise<CharacterExport> => {\r\n    let text: string;\r\n\r\n    if (navigator.clipboard && window.isSecureContext) {\r\n      text = await navigator.clipboard.readText();\r\n    } else {\r\n      throw new Error('Clipboard access not available in this browser');\r\n    }\r\n\r\n    if (!text.trim()) {\r\n      throw new Error('Clipboard is empty');\r\n    }\r\n\r\n    try {\r\n      const data = JSON.parse(text);\r\n\r\n      // Basic validation\r\n      if (!data.character || typeof data.character !== 'object') {\r\n        throw new Error('Invalid character data in clipboard');\r\n      }\r\n\r\n      return data as CharacterExport;\r\n    } catch (error) {\r\n      if (error instanceof SyntaxError) {\r\n        throw new Error('Invalid JSON format in clipboard');\r\n      }\r\n      throw error;\r\n    }\r\n  };\r\n\r\n/**\r\n * Validate character export data structure\r\n */\r\nexport const validateCharacterExport = (data: unknown): boolean => {\r\n  if (!data || typeof data !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  const dataObj = data as Record<string, unknown>;\r\n\r\n  if (!dataObj.character || typeof dataObj.character !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  const character = dataObj.character as Record<string, unknown>;\r\n\r\n  // Check required properties exist\r\n  const requiredProps = [\r\n    'name',\r\n    'abilities',\r\n    'skills',\r\n    'savingThrows',\r\n    'hitPoints',\r\n  ];\r\n  for (const prop of requiredProps) {\r\n    if (!(prop in character)) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Validate abilities structure\r\n  if (!character.abilities || typeof character.abilities !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  const abilities = character.abilities as Record<string, unknown>;\r\n  const requiredAbilities = [\r\n    'strength',\r\n    'dexterity',\r\n    'constitution',\r\n    'intelligence',\r\n    'wisdom',\r\n    'charisma',\r\n  ];\r\n  for (const ability of requiredAbilities) {\r\n    if (typeof abilities[ability] !== 'number') {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Validate skills structure\r\n  if (!character.skills || typeof character.skills !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  // Validate saving throws structure\r\n  if (!character.savingThrows || typeof character.savingThrows !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  // Validate hit points structure\r\n  if (!character.hitPoints || typeof character.hitPoints !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  const hitPoints = character.hitPoints as Record<string, unknown>;\r\n  const requiredHPProps = ['current', 'max', 'temporary'];\r\n  for (const prop of requiredHPProps) {\r\n    if (typeof hitPoints[prop] !== 'number') {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2537, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/apiClient.ts"],"sourcesContent":["/**\r\n * API client utilities for D&D data fetching\r\n */\r\n\r\nimport { ProcessedMonster, BestiaryFilters } from '@/types/bestiary';\r\nimport { ProcessedSpell } from '@/types/spells';\r\nimport { ProcessedClass } from '@/types/classes';\r\n\r\n// Base API configuration\r\nconst API_BASE = '/api';\r\n\r\n// Generic API response type\r\ninterface ApiResponse<T> {\r\n  data?: T;\r\n  error?: string;\r\n  total?: number;\r\n  hasMore?: boolean;\r\n}\r\n\r\n/**\r\n * Generic fetch wrapper with error handling\r\n */\r\nasync function apiRequest<T>(url: string): Promise<ApiResponse<T>> {\r\n  try {\r\n    const response = await fetch(url);\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n\r\n    const data = await response.json();\r\n    return { data };\r\n  } catch (error) {\r\n    console.error(`API request failed for ${url}:`, error);\r\n    return { error: error instanceof Error ? error.message : 'Unknown error' };\r\n  }\r\n}\r\n\r\n/**\r\n * Fetch all monsters from the bestiary\r\n */\r\nexport async function fetchBestiary(): Promise<ProcessedMonster[]> {\r\n  const result = await apiRequest<{\r\n    monsters: ProcessedMonster[];\r\n    total: number;\r\n  }>(`${API_BASE}/bestiary`);\r\n  return result.data?.monsters || [];\r\n}\r\n\r\n/**\r\n * Search monsters with filters and pagination\r\n */\r\nexport async function searchMonsters(\r\n  query: string = '',\r\n  filters: Partial<BestiaryFilters> = {},\r\n  limit: number = 20,\r\n  offset: number = 0\r\n): Promise<{\r\n  monsters: ProcessedMonster[];\r\n  total: number;\r\n  hasMore: boolean;\r\n}> {\r\n  const params = new URLSearchParams({\r\n    q: query,\r\n    limit: limit.toString(),\r\n    offset: offset.toString(),\r\n  });\r\n\r\n  // Add filters to params\r\n  if (filters.sizes?.length) params.set('sizes', filters.sizes.join(','));\r\n  if (filters.types?.length) params.set('types', filters.types.join(','));\r\n  if (filters.alignments?.length)\r\n    params.set('alignments', filters.alignments.join(','));\r\n  if (filters.sources?.length) params.set('sources', filters.sources.join(','));\r\n  if (filters.crRange?.min !== undefined)\r\n    params.set('crMin', filters.crRange.min.toString());\r\n  if (filters.crRange?.max !== undefined)\r\n    params.set('crMax', filters.crRange.max.toString());\r\n  if (filters.hasLegendaryActions !== undefined)\r\n    params.set('hasLegendaryActions', filters.hasLegendaryActions.toString());\r\n  if (filters.hasSpellcasting !== undefined)\r\n    params.set('hasSpellcasting', filters.hasSpellcasting.toString());\r\n  if (filters.hasConditionImmunities !== undefined)\r\n    params.set(\r\n      'hasConditionImmunities',\r\n      filters.hasConditionImmunities.toString()\r\n    );\r\n  if (filters.hasDamageResistances !== undefined)\r\n    params.set('hasDamageResistances', filters.hasDamageResistances.toString());\r\n\r\n  const result = await apiRequest<{\r\n    monsters: ProcessedMonster[];\r\n    total: number;\r\n    hasMore: boolean;\r\n  }>(`${API_BASE}/bestiary/search?${params}`);\r\n\r\n  return {\r\n    monsters: result.data?.monsters || [],\r\n    total: result.data?.total || 0,\r\n    hasMore: result.data?.hasMore || false,\r\n  };\r\n}\r\n\r\n/**\r\n * Fetch all spells\r\n */\r\nexport async function fetchSpells(): Promise<ProcessedSpell[]> {\r\n  const result = await apiRequest<{ spells: ProcessedSpell[]; total: number }>(\r\n    `${API_BASE}/spells`\r\n  );\r\n  return result.data?.spells || [];\r\n}\r\n\r\n/**\r\n * Fetch all classes\r\n */\r\nexport async function fetchClasses(): Promise<ProcessedClass[]> {\r\n  const result = await apiRequest<{ classes: ProcessedClass[]; total: number }>(\r\n    `${API_BASE}/classes`\r\n  );\r\n  return result.data?.classes || [];\r\n}\r\n\r\n/**\r\n * Get popular monsters (first 50 by name for now)\r\n * In the future, this could be based on usage analytics\r\n */\r\nexport async function fetchPopularMonsters(): Promise<ProcessedMonster[]> {\r\n  const result = await searchMonsters('', {}, 50, 0);\r\n  return result.monsters;\r\n}\r\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;AAMD,yBAAyB;AACzB,MAAM,WAAW;AAUjB;;CAEC,GACD,eAAe,WAAc,GAAW;IACtC,IAAI;QACF,MAAM,WAAW,MAAM,MAAM;QAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;QAC1D;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO;YAAE;QAAK;IAChB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,uBAAuB,EAAE,IAAI,CAAC,CAAC,EAAE;QAChD,OAAO;YAAE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAgB;IAC3E;AACF;AAKO,eAAe;IACpB,MAAM,SAAS,MAAM,WAGlB,GAAG,SAAS,SAAS,CAAC;IACzB,OAAO,OAAO,IAAI,EAAE,YAAY,EAAE;AACpC;AAKO,eAAe,eACpB,QAAgB,EAAE,EAClB,UAAoC,CAAC,CAAC,EACtC,QAAgB,EAAE,EAClB,SAAiB,CAAC;IAMlB,MAAM,SAAS,IAAI,gBAAgB;QACjC,GAAG;QACH,OAAO,MAAM,QAAQ;QACrB,QAAQ,OAAO,QAAQ;IACzB;IAEA,wBAAwB;IACxB,IAAI,QAAQ,KAAK,EAAE,QAAQ,OAAO,GAAG,CAAC,SAAS,QAAQ,KAAK,CAAC,IAAI,CAAC;IAClE,IAAI,QAAQ,KAAK,EAAE,QAAQ,OAAO,GAAG,CAAC,SAAS,QAAQ,KAAK,CAAC,IAAI,CAAC;IAClE,IAAI,QAAQ,UAAU,EAAE,QACtB,OAAO,GAAG,CAAC,cAAc,QAAQ,UAAU,CAAC,IAAI,CAAC;IACnD,IAAI,QAAQ,OAAO,EAAE,QAAQ,OAAO,GAAG,CAAC,WAAW,QAAQ,OAAO,CAAC,IAAI,CAAC;IACxE,IAAI,QAAQ,OAAO,EAAE,QAAQ,WAC3B,OAAO,GAAG,CAAC,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,QAAQ;IAClD,IAAI,QAAQ,OAAO,EAAE,QAAQ,WAC3B,OAAO,GAAG,CAAC,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,QAAQ;IAClD,IAAI,QAAQ,mBAAmB,KAAK,WAClC,OAAO,GAAG,CAAC,uBAAuB,QAAQ,mBAAmB,CAAC,QAAQ;IACxE,IAAI,QAAQ,eAAe,KAAK,WAC9B,OAAO,GAAG,CAAC,mBAAmB,QAAQ,eAAe,CAAC,QAAQ;IAChE,IAAI,QAAQ,sBAAsB,KAAK,WACrC,OAAO,GAAG,CACR,0BACA,QAAQ,sBAAsB,CAAC,QAAQ;IAE3C,IAAI,QAAQ,oBAAoB,KAAK,WACnC,OAAO,GAAG,CAAC,wBAAwB,QAAQ,oBAAoB,CAAC,QAAQ;IAE1E,MAAM,SAAS,MAAM,WAIlB,GAAG,SAAS,iBAAiB,EAAE,QAAQ;IAE1C,OAAO;QACL,UAAU,OAAO,IAAI,EAAE,YAAY,EAAE;QACrC,OAAO,OAAO,IAAI,EAAE,SAAS;QAC7B,SAAS,OAAO,IAAI,EAAE,WAAW;IACnC;AACF;AAKO,eAAe;IACpB,MAAM,SAAS,MAAM,WACnB,GAAG,SAAS,OAAO,CAAC;IAEtB,OAAO,OAAO,IAAI,EAAE,UAAU,EAAE;AAClC;AAKO,eAAe;IACpB,MAAM,SAAS,MAAM,WACnB,GAAG,SAAS,QAAQ,CAAC;IAEvB,OAAO,OAAO,IAAI,EAAE,WAAW,EAAE;AACnC;AAMO,eAAe;IACpB,MAAM,SAAS,MAAM,eAAe,IAAI,CAAC,GAAG,IAAI;IAChD,OAAO,OAAO,QAAQ;AACxB","debugId":null}},
    {"offset": {"line": 2616, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/textFormatting.ts"],"sourcesContent":["/**\r\n * Utility functions for processing D&D text formatting\r\n */\r\n\r\n/**\r\n * Process D&D text with {@...} notation and markdown-style formatting\r\n */\r\nexport function processDndText(text: string): string {\r\n  if (!text) return '';\r\n\r\n  let processedText = text;\r\n\r\n  // Handle {@dc XX} notation - convert to \"DC XX\"\r\n  processedText = processedText.replace(/\\{@dc\\s+(\\d+)\\}/g, 'DC $1');\r\n\r\n  // Handle {@variantrule Name|Source} notation - extract just the name\r\n  processedText = processedText.replace(\r\n    /\\{@variantrule\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  // Handle {@action Name|Source} notation - extract just the name\r\n  processedText = processedText.replace(\r\n    /\\{@action\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  // Handle {@condition Name|Source} notation - extract just the name\r\n  processedText = processedText.replace(\r\n    /\\{@condition\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  // Handle {@spell Name|Source} notation - extract just the name\r\n  processedText = processedText.replace(\r\n    /\\{@spell\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  // Handle {@status Name|Source} notation - extract just the name\r\n  processedText = processedText.replace(\r\n    /\\{@status\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  // Handle {@damage XdY} notation - keep as is but remove braces\r\n  processedText = processedText.replace(/\\{@damage\\s+([^}]+)\\}/g, '$1');\r\n\r\n  // Handle {@dice XdY} notation - keep as is but remove braces\r\n  processedText = processedText.replace(/\\{@dice\\s+([^}]+)\\}/g, '$1');\r\n\r\n  // Handle any remaining {@...} notation by extracting the first word after @\r\n  processedText = processedText.replace(\r\n    /\\{@\\w+\\s+([^|}\\s]+)(\\|[^}]*)?\\}/g,\r\n    '$1'\r\n  );\r\n\r\n  return processedText;\r\n}\r\n\r\n/**\r\n * Convert markdown-style bold text (**text**) to HTML\r\n */\r\nexport function markdownToHtml(text: string): string {\r\n  if (!text) return '';\r\n\r\n  // Convert **text** to <strong>text</strong>\r\n  return text.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\r\n}\r\n\r\n/**\r\n * Process D&D text with both {@...} notation and markdown formatting\r\n */\r\nexport function processAndFormatDndText(text: string): string {\r\n  return markdownToHtml(processDndText(text));\r\n}\r\n\r\n/**\r\n * Create HTML content that can be safely rendered\r\n */\r\nexport function createSafeHtml(text: string) {\r\n  return { __html: processAndFormatDndText(text) };\r\n}\r\n"],"names":[],"mappings":"AAAA;;CAEC,GAED;;CAEC;;;;;;;;;;AACM,SAAS,eAAe,IAAY;IACzC,IAAI,CAAC,MAAM,OAAO;IAElB,IAAI,gBAAgB;IAEpB,gDAAgD;IAChD,gBAAgB,cAAc,OAAO,CAAC,oBAAoB;IAE1D,qEAAqE;IACrE,gBAAgB,cAAc,OAAO,CACnC,4CACA;IAGF,gEAAgE;IAChE,gBAAgB,cAAc,OAAO,CACnC,uCACA;IAGF,mEAAmE;IACnE,gBAAgB,cAAc,OAAO,CACnC,0CACA;IAGF,+DAA+D;IAC/D,gBAAgB,cAAc,OAAO,CACnC,sCACA;IAGF,gEAAgE;IAChE,gBAAgB,cAAc,OAAO,CACnC,uCACA;IAGF,+DAA+D;IAC/D,gBAAgB,cAAc,OAAO,CAAC,0BAA0B;IAEhE,6DAA6D;IAC7D,gBAAgB,cAAc,OAAO,CAAC,wBAAwB;IAE9D,4EAA4E;IAC5E,gBAAgB,cAAc,OAAO,CACnC,oCACA;IAGF,OAAO;AACT;AAKO,SAAS,eAAe,IAAY;IACzC,IAAI,CAAC,MAAM,OAAO;IAElB,4CAA4C;IAC5C,OAAO,KAAK,OAAO,CAAC,oBAAoB;AAC1C;AAKO,SAAS,wBAAwB,IAAY;IAClD,OAAO,eAAe,eAAe;AACvC;AAKO,SAAS,eAAe,IAAY;IACzC,OAAO;QAAE,QAAQ,wBAAwB;IAAM;AACjD","debugId":null}},
    {"offset": {"line": 2670, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/conditionsDiseasesLoader.ts"],"sourcesContent":["import {\r\n  RawConditionsDiseasesData,\r\n  RawCondition,\r\n  RawDisease,\r\n  RawStatus,\r\n  ProcessedCondition,\r\n  ProcessedDisease,\r\n  ProcessedStatus,\r\n  RawConditionEntry,\r\n} from '@/types/character';\r\nimport { processAndFormatDndText } from './textFormatting';\r\n\r\n// Cache for loaded data to avoid reprocessing\r\nlet cachedConditions: ProcessedCondition[] | null = null;\r\nlet cachedDiseases: ProcessedDisease[] | null = null;\r\nlet cachedStatuses: ProcessedStatus[] | null = null;\r\n\r\n/**\r\n * Load conditions/diseases JSON file from public directory\r\n */\r\nasync function loadConditionsDiseasesFile(): Promise<RawConditionsDiseasesData> {\r\n  const response = await fetch('/data/conditionsdiseases.json');\r\n  if (!response.ok) {\r\n    throw new Error(\r\n      `Failed to load conditions/diseases data: ${response.statusText}`\r\n    );\r\n  }\r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Generate a unique ID for a condition/disease/status\r\n */\r\nfunction generateId(name: string, source: string): string {\r\n  return `${name.toLowerCase().replace(/[^a-z0-9]/g, '-')}-${source.toLowerCase()}`;\r\n}\r\n\r\n/**\r\n * Parse entries that can contain both strings and complex objects\r\n */\r\nfunction parseEntries(entries: (string | RawConditionEntry)[]): string {\r\n  const parseEntry = (entry: string | RawConditionEntry): string => {\r\n    if (typeof entry === 'string') {\r\n      return entry;\r\n    }\r\n\r\n    if (!entry || typeof entry !== 'object') {\r\n      return '';\r\n    }\r\n\r\n    try {\r\n      // Handle different entry types\r\n      if (entry.type === 'list' && entry.items) {\r\n        const processedItems = entry.items\r\n          .map((item: string | RawConditionEntry) => {\r\n            if (typeof item === 'string') {\r\n              return `• ${item}`;\r\n            }\r\n\r\n            if (!item || typeof item !== 'object') {\r\n              return '';\r\n            }\r\n\r\n            // Handle complex item objects with type: \"item\"\r\n            if (item.type === 'item') {\r\n              if (item.name && item.entry) {\r\n                return `**${item.name}**: ${item.entry}`;\r\n              }\r\n              if (item.name && item.entries) {\r\n                const entriesText = Array.isArray(item.entries)\r\n                  ? item.entries.map(parseEntry).filter(Boolean).join(' ')\r\n                  : String(item.entries);\r\n                return `**${item.name}**: ${entriesText}`;\r\n              }\r\n              if (item.entries) {\r\n                return Array.isArray(item.entries)\r\n                  ? item.entries.map(parseEntry).filter(Boolean).join(' ')\r\n                  : String(item.entries);\r\n              }\r\n              return item.entry || '';\r\n            }\r\n\r\n            // Handle other complex item types recursively\r\n            if (item.type && item.entries) {\r\n              return parseEntry(item);\r\n            }\r\n\r\n            // Handle any object with a name and some content\r\n            if (item.name) {\r\n              const content =\r\n                item.entry ||\r\n                (item.entries\r\n                  ? Array.isArray(item.entries)\r\n                    ? item.entries.map(parseEntry).join(' ')\r\n                    : String(item.entries)\r\n                  : '');\r\n              return content\r\n                ? `**${item.name}**: ${content}`\r\n                : `**${item.name}**`;\r\n            }\r\n\r\n            // Try to extract any meaningful text\r\n            if (item.entry) {\r\n              return item.entry;\r\n            }\r\n\r\n            if (item.entries) {\r\n              return Array.isArray(item.entries)\r\n                ? item.entries.map(parseEntry).filter(Boolean).join(' ')\r\n                : String(item.entries);\r\n            }\r\n\r\n            return '';\r\n          })\r\n          .filter(Boolean);\r\n\r\n        return processedItems.join('\\n\\n');\r\n      }\r\n\r\n      if (entry.type === 'entries') {\r\n        let result = '';\r\n        if (entry.name) {\r\n          result += `**${entry.name}**\\n\\n`;\r\n        }\r\n        if (entry.entries) {\r\n          const entriesText = entry.entries\r\n            .map(parseEntry)\r\n            .filter(Boolean)\r\n            .join('\\n\\n');\r\n          result += entriesText;\r\n        }\r\n        return result;\r\n      }\r\n\r\n      // Handle nested items with names (like \"Can't See\", \"Attacks Affected\", etc.)\r\n      if (entry.name && entry.entries) {\r\n        const entriesText = entry.entries\r\n          .map(parseEntry)\r\n          .filter(Boolean)\r\n          .join(' ');\r\n        return `**${entry.name}**: ${entriesText}`;\r\n      }\r\n\r\n      // Handle simple arrays\r\n      if (entry.entries && Array.isArray(entry.entries)) {\r\n        return entry.entries.map(parseEntry).filter(Boolean).join('\\n\\n');\r\n      }\r\n\r\n      // Handle single entry field\r\n      if (entry.entry) {\r\n        return entry.entry;\r\n      }\r\n\r\n      // Try to extract meaningful content from any remaining object\r\n      if (entry.name) {\r\n        return `**${entry.name}**`;\r\n      }\r\n\r\n      return '';\r\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    } catch (error) {\r\n      // Safety fallback for any parsing errors\r\n      return '';\r\n    }\r\n  };\r\n\r\n  return entries.map(parseEntry).filter(Boolean).join('\\n\\n');\r\n}\r\n\r\n/**\r\n * Process raw condition data into application format\r\n */\r\nfunction processCondition(rawCondition: RawCondition): ProcessedCondition {\r\n  const id = generateId(rawCondition.name, rawCondition.source);\r\n  const description = processAndFormatDndText(\r\n    parseEntries(rawCondition.entries)\r\n  );\r\n\r\n  // Determine if this is exhaustion and if it's stackable\r\n  const isExhaustion = rawCondition.name.toLowerCase() === 'exhaustion';\r\n  const stackable = isExhaustion; // Exhaustion is the main stackable condition\r\n\r\n  // Determine variant for conditions that have multiple versions\r\n  let variant: '2014' | '2024' | undefined;\r\n  if (rawCondition.source === 'PHB') {\r\n    variant = '2014';\r\n  } else if (rawCondition.source === 'XPHB') {\r\n    variant = '2024';\r\n  }\r\n\r\n  return {\r\n    id,\r\n    name: rawCondition.name,\r\n    source: rawCondition.source,\r\n    description,\r\n    isExhaustion,\r\n    stackable,\r\n    variant,\r\n  };\r\n}\r\n\r\n/**\r\n * Process raw disease data into application format\r\n */\r\nfunction processDisease(rawDisease: RawDisease): ProcessedDisease {\r\n  const id = generateId(rawDisease.name, rawDisease.source);\r\n  const description = processAndFormatDndText(rawDisease.entries.join('\\n\\n'));\r\n\r\n  return {\r\n    id,\r\n    name: rawDisease.name,\r\n    source: rawDisease.source,\r\n    description,\r\n    type: rawDisease.type,\r\n  };\r\n}\r\n\r\n/**\r\n * Process raw status data into application format\r\n */\r\nfunction processStatus(rawStatus: RawStatus): ProcessedStatus {\r\n  const id = generateId(rawStatus.name, rawStatus.source);\r\n  const description = processAndFormatDndText(parseEntries(rawStatus.entries));\r\n\r\n  return {\r\n    id,\r\n    name: rawStatus.name,\r\n    source: rawStatus.source,\r\n    description,\r\n  };\r\n}\r\n\r\n/**\r\n * Load and process all conditions\r\n */\r\nexport async function loadAllConditions(): Promise<ProcessedCondition[]> {\r\n  if (cachedConditions) {\r\n    return cachedConditions;\r\n  }\r\n\r\n  try {\r\n    const data = await loadConditionsDiseasesFile();\r\n    const processedConditions = data.condition.map(processCondition);\r\n\r\n    cachedConditions = processedConditions;\r\n\r\n    console.log(`Loaded ${cachedConditions.length} conditions`);\r\n\r\n    return cachedConditions;\r\n  } catch (error) {\r\n    console.error('Error loading conditions:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Load and process all diseases\r\n */\r\nexport async function loadAllDiseases(): Promise<ProcessedDisease[]> {\r\n  if (cachedDiseases) {\r\n    return cachedDiseases;\r\n  }\r\n\r\n  try {\r\n    const data = await loadConditionsDiseasesFile();\r\n    const processedDiseases = data.disease.map(processDisease);\r\n\r\n    cachedDiseases = processedDiseases;\r\n\r\n    console.log(`Loaded ${cachedDiseases.length} diseases`);\r\n\r\n    return cachedDiseases;\r\n  } catch (error) {\r\n    console.error('Error loading diseases:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Load and process all statuses\r\n */\r\nexport async function loadAllStatuses(): Promise<ProcessedStatus[]> {\r\n  if (cachedStatuses) {\r\n    return cachedStatuses;\r\n  }\r\n\r\n  try {\r\n    const data = await loadConditionsDiseasesFile();\r\n    const processedStatuses = data.status.map(processStatus);\r\n\r\n    cachedStatuses = processedStatuses;\r\n\r\n    console.log(`Loaded ${cachedStatuses.length} statuses`);\r\n\r\n    return cachedStatuses;\r\n  } catch (error) {\r\n    console.error('Error loading statuses:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Get exhaustion conditions by variant\r\n */\r\nexport async function getExhaustionByVariant(\r\n  variant: '2014' | '2024'\r\n): Promise<ProcessedCondition | null> {\r\n  const conditions = await loadAllConditions();\r\n  return conditions.find(c => c.isExhaustion && c.variant === variant) || null;\r\n}\r\n\r\n/**\r\n * Search conditions by name\r\n */\r\nexport async function searchConditions(\r\n  query: string\r\n): Promise<ProcessedCondition[]> {\r\n  const conditions = await loadAllConditions();\r\n  const lowerQuery = query.toLowerCase();\r\n\r\n  return conditions.filter(\r\n    condition =>\r\n      condition.name.toLowerCase().includes(lowerQuery) ||\r\n      condition.description.toLowerCase().includes(lowerQuery)\r\n  );\r\n}\r\n\r\n/**\r\n * Search diseases by name\r\n */\r\nexport async function searchDiseases(\r\n  query: string\r\n): Promise<ProcessedDisease[]> {\r\n  const diseases = await loadAllDiseases();\r\n  const lowerQuery = query.toLowerCase();\r\n\r\n  return diseases.filter(\r\n    disease =>\r\n      disease.name.toLowerCase().includes(lowerQuery) ||\r\n      disease.description.toLowerCase().includes(lowerQuery)\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2908, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/diceUtils.ts"],"sourcesContent":["import { DiceRollResults, ParsedDiceNotation, RollSummary } from '@/types/dice';\r\n\r\n/**\r\n * Parse dice notation like \"3d12+5\" or \"1d20-2\"\r\n */\r\nexport function parseDiceNotation(notation: string): ParsedDiceNotation {\r\n  // Remove spaces\r\n  const clean = notation.replace(/\\s/g, '');\r\n\r\n  // Match pattern like \"3d12+5\" or \"1d20-2\"\r\n  const match = clean.match(/^(\\d+)?d(\\d+)([+-]\\d+)?$/i);\r\n\r\n  if (!match) {\r\n    throw new Error(`Invalid dice notation: ${notation}`);\r\n  }\r\n\r\n  const count = parseInt(match[1] || '1', 10);\r\n  const sides = parseInt(match[2], 10);\r\n  const modifierStr = match[3] || '+0';\r\n  const modifier = parseInt(modifierStr, 10);\r\n\r\n  return {\r\n    count,\r\n    sides,\r\n    modifier,\r\n    originalNotation: notation,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate roll summary from dice results\r\n */\r\nexport function calculateRollSummary(\r\n  diceResults: DiceRollResults,\r\n  notation: string\r\n): RollSummary {\r\n  const parsed = parseDiceNotation(notation);\r\n  const individualValues = diceResults.map(die => die.value);\r\n  const diceTotal = individualValues.reduce((sum, value) => sum + value, 0);\r\n  const finalTotal = diceTotal + parsed.modifier;\r\n\r\n  return {\r\n    diceResults,\r\n    individualValues,\r\n    total: diceTotal,\r\n    modifier: parsed.modifier,\r\n    finalTotal,\r\n    notation,\r\n    rollTime: new Date(),\r\n    rollId: generateRollId(),\r\n  };\r\n}\r\n\r\n/**\r\n * Generate a unique roll ID\r\n */\r\nfunction generateRollId(): string {\r\n  return Date.now().toString(36) + Math.random().toString(36).substr(2);\r\n}\r\n\r\n/**\r\n * Format dice results for display\r\n */\r\nexport function formatDiceResults(summary: RollSummary): string {\r\n  const { individualValues, modifier, finalTotal, notation } = summary;\r\n\r\n  const diceStr = individualValues.join(' + ');\r\n\r\n  if (modifier === 0) {\r\n    return `${notation}: [${diceStr}] = ${finalTotal}`;\r\n  } else {\r\n    const modStr = modifier > 0 ? `+${modifier}` : `${modifier}`;\r\n    return `${notation}: [${diceStr}] ${modStr} = ${finalTotal}`;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a roll contains any maximum values (critical success indicator)\r\n */\r\nexport function hasCriticalSuccess(results: DiceRollResults): boolean {\r\n  return results.some(die => die.value === die.sides && die.sides === 20);\r\n}\r\n\r\n/**\r\n * Check if a roll contains any minimum values (critical failure indicator)\r\n */\r\nexport function hasCriticalFailure(results: DiceRollResults): boolean {\r\n  return results.some(die => die.value === 1 && die.sides === 20);\r\n}\r\n\r\n/**\r\n * Get color class based on roll results\r\n */\r\nexport function getRollResultColor(summary: RollSummary): string {\r\n  if (hasCriticalSuccess(summary.diceResults)) {\r\n    return 'text-green-600 font-bold'; // Critical success\r\n  } else if (hasCriticalFailure(summary.diceResults)) {\r\n    return 'text-red-600 font-bold'; // Critical failure\r\n  } else {\r\n    return 'text-gray-800'; // Normal roll\r\n  }\r\n}\r\n\r\n/**\r\n * Auto-clear dice after a delay\r\n */\r\nexport function autoClearDice(\r\n  diceBox: { clear?: () => void },\r\n  delay: number = 3000,\r\n  onClear?: () => void\r\n): void {\r\n  setTimeout(() => {\r\n    try {\r\n      if (diceBox && typeof diceBox.clear === 'function') {\r\n        diceBox.clear();\r\n        if (onClear) {\r\n          onClear();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn('Error during auto-clear dice:', error);\r\n    }\r\n  }, delay);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAKO,SAAS,kBAAkB,QAAgB;IAChD,gBAAgB;IAChB,MAAM,QAAQ,SAAS,OAAO,CAAC,OAAO;IAEtC,0CAA0C;IAC1C,MAAM,QAAQ,MAAM,KAAK,CAAC;IAE1B,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IAEA,MAAM,QAAQ,SAAS,KAAK,CAAC,EAAE,IAAI,KAAK;IACxC,MAAM,QAAQ,SAAS,KAAK,CAAC,EAAE,EAAE;IACjC,MAAM,cAAc,KAAK,CAAC,EAAE,IAAI;IAChC,MAAM,WAAW,SAAS,aAAa;IAEvC,OAAO;QACL;QACA;QACA;QACA,kBAAkB;IACpB;AACF;AAKO,SAAS,qBACd,WAA4B,EAC5B,QAAgB;IAEhB,MAAM,SAAS,kBAAkB;IACjC,MAAM,mBAAmB,YAAY,GAAG,CAAC,CAAA,MAAO,IAAI,KAAK;IACzD,MAAM,YAAY,iBAAiB,MAAM,CAAC,CAAC,KAAK,QAAU,MAAM,OAAO;IACvE,MAAM,aAAa,YAAY,OAAO,QAAQ;IAE9C,OAAO;QACL;QACA;QACA,OAAO;QACP,UAAU,OAAO,QAAQ;QACzB;QACA;QACA,UAAU,IAAI;QACd,QAAQ;IACV;AACF;AAEA;;CAEC,GACD,SAAS;IACP,OAAO,KAAK,GAAG,GAAG,QAAQ,CAAC,MAAM,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC;AACrE;AAKO,SAAS,kBAAkB,OAAoB;IACpD,MAAM,EAAE,gBAAgB,EAAE,QAAQ,EAAE,UAAU,EAAE,QAAQ,EAAE,GAAG;IAE7D,MAAM,UAAU,iBAAiB,IAAI,CAAC;IAEtC,IAAI,aAAa,GAAG;QAClB,OAAO,GAAG,SAAS,GAAG,EAAE,QAAQ,IAAI,EAAE,YAAY;IACpD,OAAO;QACL,MAAM,SAAS,WAAW,IAAI,CAAC,CAAC,EAAE,UAAU,GAAG,GAAG,UAAU;QAC5D,OAAO,GAAG,SAAS,GAAG,EAAE,QAAQ,EAAE,EAAE,OAAO,GAAG,EAAE,YAAY;IAC9D;AACF;AAKO,SAAS,mBAAmB,OAAwB;IACzD,OAAO,QAAQ,IAAI,CAAC,CAAA,MAAO,IAAI,KAAK,KAAK,IAAI,KAAK,IAAI,IAAI,KAAK,KAAK;AACtE;AAKO,SAAS,mBAAmB,OAAwB;IACzD,OAAO,QAAQ,IAAI,CAAC,CAAA,MAAO,IAAI,KAAK,KAAK,KAAK,IAAI,KAAK,KAAK;AAC9D;AAKO,SAAS,mBAAmB,OAAoB;IACrD,IAAI,mBAAmB,QAAQ,WAAW,GAAG;QAC3C,OAAO,4BAA4B,mBAAmB;IACxD,OAAO,IAAI,mBAAmB,QAAQ,WAAW,GAAG;QAClD,OAAO,0BAA0B,mBAAmB;IACtD,OAAO;QACL,OAAO,iBAAiB,cAAc;IACxC;AACF;AAKO,SAAS,cACd,OAA+B,EAC/B,QAAgB,IAAI,EACpB,OAAoB;IAEpB,WAAW;QACT,IAAI;YACF,IAAI,WAAW,OAAO,QAAQ,KAAK,KAAK,YAAY;gBAClD,QAAQ,KAAK;gBACb,IAAI,SAAS;oBACX;gBACF;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,IAAI,CAAC,iCAAiC;QAChD;IACF,GAAG;AACL","debugId":null}},
    {"offset": {"line": 3007, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/referenceParser.ts"],"sourcesContent":["export interface ParsedReference {\r\n  type:\r\n    | 'item'\r\n    | 'spell'\r\n    | 'filter'\r\n    | 'dice'\r\n    | 'creature'\r\n    | 'condition'\r\n    | 'action'\r\n    | 'skill'\r\n    | 'sense'\r\n    | 'damage'\r\n    | 'scaledamage'\r\n    | 'atk'\r\n    | 'atkr'\r\n    | 'hit'\r\n    | 'h'\r\n    | 'dc'\r\n    | 'actSave'\r\n    | 'actSaveFail'\r\n    | 'actSaveSuccess'\r\n    | 'actTrigger'\r\n    | 'actResponse'\r\n    | 'hitYourSpellAttack'\r\n    | 'unknown';\r\n  name: string;\r\n  source?: string;\r\n  displayText: string;\r\n  properties?: Record<string, string>;\r\n  isReference: boolean;\r\n}\r\n\r\nexport interface ParsedContent {\r\n  text: string;\r\n  references: ParsedReference[];\r\n  html: string;\r\n}\r\n\r\n/**\r\n * Parse 5etools-style references from text content\r\n * Formats: {@type name|source|extra}, {@type name|source}, {@type name}\r\n */\r\nexport function parseReferences(content: string): ParsedContent {\r\n  if (!content) {\r\n    return { text: content, references: [], html: content };\r\n  }\r\n\r\n  const references: ParsedReference[] = [];\r\n  let parsedHtml = content;\r\n\r\n  // Regex to match {@type content} patterns\r\n  const referenceRegex = /\\{@(\\w+)\\s+([^}]+)\\}/g;\r\n\r\n  let match;\r\n  while ((match = referenceRegex.exec(content)) !== null) {\r\n    const [fullMatch, type, content] = match;\r\n    const parts = content.split('|');\r\n\r\n    const name = parts[0]?.trim() || '';\r\n    const source = parts[1]?.trim();\r\n    const extra = parts.slice(2);\r\n\r\n    const reference: ParsedReference = {\r\n      type: normalizeReferenceType(type),\r\n      name,\r\n      source,\r\n      displayText: formatDisplayText(type, name, source, extra),\r\n      properties: parseExtraProperties(extra),\r\n      isReference: true,\r\n    };\r\n\r\n    references.push(reference);\r\n\r\n    // Replace in HTML with styled version\r\n    parsedHtml = parsedHtml.replace(fullMatch, formatReferenceHtml(reference));\r\n  }\r\n\r\n  // Clean up any remaining malformed references\r\n  parsedHtml = parsedHtml.replace(/\\{@\\w+[^}]*\\}/g, match => {\r\n    // If we couldn't parse it properly, just remove the {@...} wrapper\r\n    return match.replace(/\\{@\\w+\\s*/, '').replace(/\\}$/, '');\r\n  });\r\n\r\n  return {\r\n    text: content,\r\n    references,\r\n    html: parsedHtml,\r\n  };\r\n}\r\n\r\n/**\r\n * Normalize reference types to known categories\r\n */\r\nfunction normalizeReferenceType(type: string): ParsedReference['type'] {\r\n  const typeMap: Record<string, ParsedReference['type']> = {\r\n    item: 'item',\r\n    spell: 'spell',\r\n    filter: 'filter',\r\n    dice: 'dice',\r\n    creature: 'creature',\r\n    condition: 'condition',\r\n    action: 'action',\r\n    skill: 'skill',\r\n    sense: 'sense',\r\n    damage: 'damage',\r\n    scaledamage: 'scaledamage',\r\n    atk: 'atk',\r\n    atkr: 'atkr',\r\n    hit: 'hit',\r\n    h: 'h',\r\n    dc: 'dc',\r\n    actsave: 'actSave',\r\n    actsavefail: 'actSaveFail',\r\n    actsavesuccess: 'actSaveSuccess',\r\n    acttrigger: 'actTrigger',\r\n    actresponse: 'actResponse',\r\n    hityourspellattack: 'hitYourSpellAttack',\r\n    // Add more mappings as needed\r\n  };\r\n\r\n  return typeMap[type.toLowerCase()] || 'unknown';\r\n}\r\n\r\n/**\r\n * Parse scaled damage format: {@scaledamage baseDamage|levelRange|additionalPerLevel}\r\n * Example: {@scaledamage 8d6|3-9|1d6} -> \"8d6 (+ 1d6 per level above 3rd)\"\r\n */\r\nfunction parseScaledDamage(\r\n  baseDamage: string,\r\n  levelRange?: string,\r\n  extra?: string[]\r\n): string {\r\n  if (!levelRange || !extra || extra.length === 0) {\r\n    return baseDamage; // Fallback to base damage if parsing fails\r\n  }\r\n\r\n  const additionalPerLevel = extra[0];\r\n  const levelParts = levelRange.split('-');\r\n  const startLevel = levelParts[0];\r\n\r\n  if (!startLevel || !additionalPerLevel) {\r\n    return baseDamage;\r\n  }\r\n\r\n  // Format the level suffix (1st, 2nd, 3rd, 4th, etc.)\r\n  const levelSuffix = getLevelSuffix(parseInt(startLevel));\r\n\r\n  return `${baseDamage} (+ ${additionalPerLevel} per level above ${levelSuffix})`;\r\n}\r\n\r\n/**\r\n * Get the ordinal suffix for a level number\r\n */\r\nfunction getLevelSuffix(level: number): string {\r\n  if (level >= 11 && level <= 13) {\r\n    return `${level}th`;\r\n  }\r\n\r\n  const lastDigit = level % 10;\r\n  switch (lastDigit) {\r\n    case 1:\r\n      return `${level}st`;\r\n    case 2:\r\n      return `${level}nd`;\r\n    case 3:\r\n      return `${level}rd`;\r\n    default:\r\n      return `${level}th`;\r\n  }\r\n}\r\n\r\n/**\r\n * Format display text based on reference type and content\r\n */\r\nfunction formatDisplayText(\r\n  type: string,\r\n  name: string,\r\n  source?: string,\r\n  extra?: string[]\r\n): string {\r\n  switch (type.toLowerCase()) {\r\n    case 'item':\r\n      return name;\r\n\r\n    case 'filter':\r\n      return name;\r\n\r\n    case 'spell':\r\n      return name;\r\n\r\n    case 'dice':\r\n      return name;\r\n\r\n    case 'creature':\r\n      return name;\r\n\r\n    case 'condition':\r\n      return name;\r\n\r\n    case 'action':\r\n      return name;\r\n\r\n    case 'skill':\r\n      return name;\r\n\r\n    case 'sense':\r\n      return name;\r\n\r\n    case 'damage':\r\n      return name;\r\n\r\n    case 'scaledamage':\r\n      return parseScaledDamage(name, source, extra);\r\n\r\n    case 'atk':\r\n      // Handle attack types like \"mw\" (melee weapon), \"rw\" (ranged weapon)\r\n      switch (name.toLowerCase()) {\r\n        case 'm':\r\n        case 'mw':\r\n          return 'Melee Weapon Attack:';\r\n        case 'r':\r\n        case 'rw':\r\n          return 'Ranged Weapon Attack:';\r\n        case 'ms':\r\n          return 'Melee Spell Attack:';\r\n        case 'rs':\r\n          return 'Ranged Spell Attack:';\r\n        default:\r\n          return `${name} Attack:`;\r\n      }\r\n\r\n    case 'atkr':\r\n      // Handle ranged attack types\r\n      switch (name.toLowerCase()) {\r\n        case 'm':\r\n          return 'Melee Attack:';\r\n        case 'r':\r\n          return 'Ranged Attack:';\r\n        default:\r\n          return `${name} Attack:`;\r\n      }\r\n\r\n    case 'hit':\r\n      return `+${name}`;\r\n\r\n    case 'h':\r\n      return `Hit: ${name}`;\r\n\r\n    case 'dc':\r\n      return `DC ${name}`;\r\n\r\n    case 'actsave':\r\n      return `${name.toUpperCase()} save`;\r\n\r\n    case 'actsavefail':\r\n      return 'On a failed save:';\r\n\r\n    case 'actsavesuccess':\r\n      return 'On a successful save:';\r\n\r\n    case 'acttrigger':\r\n      return `Trigger: ${name}`;\r\n\r\n    case 'actresponse':\r\n      return `Response: ${name}`;\r\n\r\n    case 'hityourspellattack':\r\n      return name; // This typically contains the full text like \"Bonus equals your spell attack modifier\"\r\n\r\n    default:\r\n      return name;\r\n  }\r\n}\r\n\r\n/**\r\n * Parse extra properties from reference parts\r\n */\r\nfunction parseExtraProperties(extra: string[]): Record<string, string> {\r\n  const properties: Record<string, string> = {};\r\n\r\n  extra.forEach((prop, index) => {\r\n    if (prop.includes('=')) {\r\n      const [key, value] = prop.split('=', 2);\r\n      properties[key.trim()] = value.trim();\r\n    } else {\r\n      properties[`extra_${index}`] = prop.trim();\r\n    }\r\n  });\r\n\r\n  return properties;\r\n}\r\n\r\n/**\r\n * Format reference as HTML with appropriate styling\r\n */\r\nfunction formatReferenceHtml(reference: ParsedReference): string {\r\n  const baseClasses =\r\n    'inline-flex items-center gap-1 px-2 py-1 rounded text-sm font-medium transition-colors';\r\n\r\n  let typeClasses = '';\r\n  let icon = '';\r\n\r\n  switch (reference.type) {\r\n    case 'item':\r\n      typeClasses =\r\n        'bg-amber-500/10 text-amber-400 border border-amber-500/20 hover:bg-amber-500/20';\r\n      icon = '⚔️';\r\n      break;\r\n\r\n    case 'spell':\r\n      typeClasses =\r\n        'bg-purple-500/10 text-purple-400 border border-purple-500/20 hover:bg-purple-500/20';\r\n      icon = '✨';\r\n      break;\r\n\r\n    case 'filter':\r\n      typeClasses =\r\n        'bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20';\r\n      icon = '🔍';\r\n      break;\r\n\r\n    case 'dice':\r\n      typeClasses =\r\n        'bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20';\r\n      icon = '🎲';\r\n      break;\r\n\r\n    case 'creature':\r\n      typeClasses =\r\n        'bg-green-500/10 text-green-400 border border-green-500/20 hover:bg-green-500/20';\r\n      icon = '🐉';\r\n      break;\r\n\r\n    case 'condition':\r\n      typeClasses =\r\n        'bg-orange-500/10 text-orange-400 border border-orange-500/20 hover:bg-orange-500/20';\r\n      icon = '💫';\r\n      break;\r\n\r\n    case 'action':\r\n      typeClasses =\r\n        'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 hover:bg-indigo-500/20';\r\n      icon = '⚡';\r\n      break;\r\n\r\n    case 'skill':\r\n      typeClasses =\r\n        'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 hover:bg-cyan-500/20';\r\n      icon = '🎯';\r\n      break;\r\n\r\n    case 'sense':\r\n      typeClasses =\r\n        'bg-pink-500/10 text-pink-400 border border-pink-500/20 hover:bg-pink-500/20';\r\n      icon = '👁️';\r\n      break;\r\n\r\n    case 'damage':\r\n      typeClasses =\r\n        'bg-red-600/10 text-red-400 border border-red-600/20 hover:bg-red-600/20';\r\n      icon = '💥';\r\n      break;\r\n\r\n    case 'scaledamage':\r\n      typeClasses =\r\n        'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20';\r\n      icon = '📈';\r\n      break;\r\n\r\n    case 'atk':\r\n      typeClasses =\r\n        'bg-violet-500/10 text-violet-400 border border-violet-500/20 hover:bg-violet-500/20';\r\n      icon = '⚔️';\r\n      break;\r\n\r\n    case 'atkr':\r\n      typeClasses =\r\n        'bg-violet-600/10 text-violet-400 border border-violet-600/20 hover:bg-violet-600/20';\r\n      icon = '🏹';\r\n      break;\r\n\r\n    case 'hit':\r\n      typeClasses =\r\n        'bg-emerald-600/10 text-emerald-400 border border-emerald-600/20 hover:bg-emerald-600/20';\r\n      icon = '🎯';\r\n      break;\r\n\r\n    case 'h':\r\n      typeClasses =\r\n        'bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20';\r\n      icon = '💥';\r\n      break;\r\n\r\n    case 'dc':\r\n      typeClasses =\r\n        'bg-blue-600/10 text-blue-400 border border-blue-600/20 hover:bg-blue-600/20';\r\n      icon = '🔢';\r\n      break;\r\n\r\n    case 'actSave':\r\n      typeClasses =\r\n        'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500/20';\r\n      icon = '🛡️';\r\n      break;\r\n\r\n    case 'actSaveFail':\r\n      typeClasses =\r\n        'bg-red-700/10 text-red-400 border border-red-700/20 hover:bg-red-700/20';\r\n      icon = '❌';\r\n      break;\r\n\r\n    case 'actSaveSuccess':\r\n      typeClasses =\r\n        'bg-green-600/10 text-green-400 border border-green-600/20 hover:bg-green-600/20';\r\n      icon = '✅';\r\n      break;\r\n\r\n    case 'actTrigger':\r\n      typeClasses =\r\n        'bg-orange-600/10 text-orange-400 border border-orange-600/20 hover:bg-orange-600/20';\r\n      icon = '⚡';\r\n      break;\r\n\r\n    case 'actResponse':\r\n      typeClasses =\r\n        'bg-indigo-600/10 text-indigo-400 border border-indigo-600/20 hover:bg-indigo-600/20';\r\n      icon = '↩️';\r\n      break;\r\n\r\n    case 'hitYourSpellAttack':\r\n      typeClasses =\r\n        'bg-purple-600/10 text-purple-400 border border-purple-600/20 hover:bg-purple-600/20';\r\n      icon = '✨';\r\n      break;\r\n\r\n    default:\r\n      typeClasses =\r\n        'bg-slate-500/10 text-slate-400 border border-slate-500/20 hover:bg-slate-500/20';\r\n      icon = '❓';\r\n  }\r\n\r\n  const title = reference.source\r\n    ? `${reference.displayText} (${reference.source})`\r\n    : reference.displayText;\r\n\r\n  return `<span class=\"${baseClasses} ${typeClasses}\" title=\"${title}\">${icon} ${reference.displayText}</span>`;\r\n}\r\n\r\n/**\r\n * Extract plain text from parsed content (removes all reference formatting)\r\n */\r\nexport function getPlainText(content: string): string {\r\n  return parseReferences(content).html.replace(/<[^>]*>/g, '');\r\n}\r\n\r\n/**\r\n * Get all references from content\r\n */\r\nexport function extractReferences(content: string): ParsedReference[] {\r\n  return parseReferences(content).references;\r\n}\r\n\r\n/**\r\n * Check if content contains references\r\n */\r\nexport function hasReferences(content: string): boolean {\r\n  return /\\{@\\w+\\s+[^}]+\\}/.test(content);\r\n}\r\n\r\n/**\r\n * Get formatted HTML for React components\r\n */\r\nexport function getFormattedHtml(content: string): string {\r\n  return parseReferences(content).html;\r\n}\r\n\r\n/**\r\n * Format reference as bold HTML for WYSIWYG editor\r\n * Used in spell edit modal to make important references stand out\r\n */\r\nfunction formatReferenceForEditor(reference: ParsedReference): string {\r\n  // For most references, just bold the display text\r\n  return `<strong>${reference.displayText}</strong>`;\r\n}\r\n\r\n/**\r\n * Parse references and format them for WYSIWYG editor\r\n * Converts {@...} tags to bold text for better editing experience\r\n */\r\nexport function formatSpellDescriptionForEditor(content: string): string {\r\n  if (!content) {\r\n    return '';\r\n  }\r\n\r\n  let formattedHtml = content;\r\n\r\n  // Regex to match {@type content} patterns\r\n  const referenceRegex = /\\{@(\\w+)\\s+([^}]+)\\}/g;\r\n\r\n  let match;\r\n  const replacements: Array<{ from: string; to: string }> = [];\r\n\r\n  while ((match = referenceRegex.exec(content)) !== null) {\r\n    const [fullMatch, type, content] = match;\r\n    const parts = content.split('|');\r\n\r\n    const name = parts[0]?.trim() || '';\r\n    const source = parts[1]?.trim();\r\n    const extra = parts.slice(2);\r\n\r\n    const reference: ParsedReference = {\r\n      type: normalizeReferenceType(type),\r\n      name,\r\n      source,\r\n      displayText: formatDisplayText(type, name, source, extra),\r\n      properties: parseExtraProperties(extra),\r\n      isReference: true,\r\n    };\r\n\r\n    // Replace with bold HTML for editor\r\n    replacements.push({\r\n      from: fullMatch,\r\n      to: formatReferenceForEditor(reference),\r\n    });\r\n  }\r\n\r\n  // Apply all replacements\r\n  replacements.forEach(({ from, to }) => {\r\n    formattedHtml = formattedHtml.replace(from, to);\r\n  });\r\n\r\n  // Clean up any remaining malformed references\r\n  formattedHtml = formattedHtml.replace(/\\{@\\w+[^}]*\\}/g, match => {\r\n    // If we couldn't parse it properly, just remove the {@...} wrapper\r\n    return match.replace(/\\{@\\w+\\s*/, '').replace(/\\}$/, '');\r\n  });\r\n\r\n  // Convert newlines to proper paragraph breaks for the editor\r\n  // Split by double newlines (paragraph breaks)\r\n  const paragraphs = formattedHtml.split('\\n\\n');\r\n\r\n  // Wrap each paragraph in <p> tags if not already wrapped\r\n  const wrappedParagraphs = paragraphs\r\n    .map(para => {\r\n      const trimmed = para.trim();\r\n      if (!trimmed) return '';\r\n      // If it already starts with an HTML tag, leave it as is\r\n      if (trimmed.startsWith('<')) return trimmed;\r\n      // Otherwise wrap in <p> tags\r\n      return `<p>${trimmed.replace(/\\n/g, '<br>')}</p>`;\r\n    })\r\n    .filter(Boolean);\r\n\r\n  return wrappedParagraphs.join('');\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3392, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/featureConversion.ts"],"sourcesContent":["/**\r\n * Feature Conversion Utilities\r\n * Converts ProcessedBackgroundFeature, ProcessedFeat, and ClassFeature\r\n * to ExtendedFeature format for character sheet\r\n */\r\n\r\nimport { ExtendedFeature } from '@/types/character';\r\nimport type {\r\n  ProcessedBackgroundFeature,\r\n  ProcessedFeat,\r\n} from '@/types/features';\r\nimport { ClassFeature } from '@/types/classes';\r\nimport { formatSpellDescriptionForEditor } from './referenceParser';\r\n\r\n/**\r\n * Try to detect if a feature has limited uses from its description\r\n */\r\nfunction parseUsesFromDescription(\r\n  description: string\r\n): { maxUses: number; restType: 'short' | 'long' } | null {\r\n  const desc = description.toLowerCase();\r\n\r\n  // Check for short rest recharge\r\n  if (desc.includes('short rest') || desc.includes('short or long rest')) {\r\n    // Try to find number of uses\r\n    const usesMatch = desc.match(/(\\d+)\\s+(?:time|use)s?/i);\r\n    if (usesMatch) {\r\n      return {\r\n        maxUses: parseInt(usesMatch[1]),\r\n        restType: 'short',\r\n      };\r\n    }\r\n    return {\r\n      maxUses: 1,\r\n      restType: 'short',\r\n    };\r\n  }\r\n\r\n  // Check for long rest recharge\r\n  if (desc.includes('long rest') || desc.includes('finish a rest')) {\r\n    const usesMatch = desc.match(/(\\d+)\\s+(?:time|use)s?/i);\r\n    if (usesMatch) {\r\n      return {\r\n        maxUses: parseInt(usesMatch[1]),\r\n        restType: 'long',\r\n      };\r\n    }\r\n    return {\r\n      maxUses: 1,\r\n      restType: 'long',\r\n    };\r\n  }\r\n\r\n  // Check for once per day\r\n  if (desc.includes('once per day') || desc.includes('once a day')) {\r\n    return {\r\n      maxUses: 1,\r\n      restType: 'long',\r\n    };\r\n  }\r\n\r\n  // Check for proficiency bonus times per day/rest\r\n  if (\r\n    desc.includes('proficiency bonus') &&\r\n    (desc.includes('per day') || desc.includes('per long rest'))\r\n  ) {\r\n    return {\r\n      maxUses: 0, // Will be calculated dynamically\r\n      restType: 'long',\r\n    };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Detect if feature scales with proficiency bonus\r\n */\r\nfunction detectProficiencyScaling(description: string): {\r\n  scales: boolean;\r\n  multiplier: number;\r\n} {\r\n  const desc = description.toLowerCase();\r\n\r\n  if (\r\n    desc.includes('proficiency bonus') &&\r\n    (desc.includes('equal to') || desc.includes('number of times'))\r\n  ) {\r\n    // Check for multipliers like \"twice your proficiency bonus\"\r\n    if (\r\n      desc.includes('twice') ||\r\n      desc.includes('two times') ||\r\n      desc.includes('2 ×')\r\n    ) {\r\n      return { scales: true, multiplier: 2 };\r\n    }\r\n\r\n    return { scales: true, multiplier: 1 };\r\n  }\r\n\r\n  return { scales: false, multiplier: 1 };\r\n}\r\n\r\n/**\r\n * Convert ProcessedBackgroundFeature to Partial<ExtendedFeature>\r\n */\r\nexport function convertBackgroundFeatureToExtendedFeature(\r\n  feature: ProcessedBackgroundFeature\r\n): Partial<ExtendedFeature> {\r\n  const formattedDescription = formatSpellDescriptionForEditor(\r\n    feature.description\r\n  );\r\n  const usageInfo = parseUsesFromDescription(feature.description);\r\n\r\n  return {\r\n    name: feature.name,\r\n    description: formattedDescription,\r\n    sourceType: 'background',\r\n    sourceDetail: feature.backgroundName,\r\n    category: 'Background Feature',\r\n    maxUses: usageInfo?.maxUses || 0,\r\n    restType: usageInfo?.restType || 'long',\r\n    isPassive: !usageInfo, // If no usage info detected, assume passive\r\n    scaleWithProficiency: false,\r\n    proficiencyMultiplier: 1,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert ProcessedFeat to Partial<ExtendedFeature>\r\n */\r\nexport function convertFeatToExtendedFeature(\r\n  feat: ProcessedFeat\r\n): Partial<ExtendedFeature> {\r\n  const formattedDescription = formatSpellDescriptionForEditor(\r\n    feat.description\r\n  );\r\n  const usageInfo = parseUsesFromDescription(feat.description);\r\n  const scalingInfo = detectProficiencyScaling(feat.description);\r\n\r\n  // Build source detail string\r\n  let sourceDetail = feat.source;\r\n  if (feat.prerequisites.length > 0) {\r\n    sourceDetail += ` (Requires: ${feat.prerequisites.join(', ')})`;\r\n  }\r\n  if (feat.abilityIncreases) {\r\n    sourceDetail += ` [${feat.abilityIncreases}]`;\r\n  }\r\n\r\n  return {\r\n    name: feat.name,\r\n    description: formattedDescription,\r\n    sourceType: 'feat',\r\n    sourceDetail,\r\n    category: feat.grantsSpells ? 'Spellcasting Feat' : 'General Feat',\r\n    maxUses: usageInfo?.maxUses || 0,\r\n    restType: usageInfo?.restType || 'long',\r\n    isPassive: !usageInfo,\r\n    scaleWithProficiency: scalingInfo.scales,\r\n    proficiencyMultiplier: scalingInfo.multiplier,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert ClassFeature to Partial<ExtendedFeature>\r\n */\r\nexport function convertClassFeatureToExtendedFeature(\r\n  feature: ClassFeature\r\n): Partial<ExtendedFeature> {\r\n  const description = feature.entries?.join('\\n\\n') || '';\r\n  const formattedDescription = formatSpellDescriptionForEditor(description);\r\n  const usageInfo = parseUsesFromDescription(description);\r\n  const scalingInfo = detectProficiencyScaling(description);\r\n\r\n  // Build source detail\r\n  const sourceDetail =\r\n    feature.isSubclassFeature && feature.subclassShortName\r\n      ? `${feature.subclassShortName} Level ${feature.level}`\r\n      : `${feature.className} Level ${feature.level}`;\r\n\r\n  return {\r\n    name: feature.name,\r\n    description: formattedDescription,\r\n    sourceType: 'class',\r\n    sourceDetail,\r\n    category: feature.isSubclassFeature ? 'Subclass Feature' : 'Class Feature',\r\n    maxUses: usageInfo?.maxUses || 0,\r\n    restType: usageInfo?.restType || 'long',\r\n    isPassive: !usageInfo,\r\n    scaleWithProficiency: scalingInfo.scales,\r\n    proficiencyMultiplier: scalingInfo.multiplier,\r\n  };\r\n}\r\n\r\n/**\r\n * Create form data for feature from autocomplete selection\r\n */\r\nexport interface FeatureFormData {\r\n  name: string;\r\n  description: string;\r\n  sourceType: ExtendedFeature['sourceType'];\r\n  sourceDetail: string;\r\n  category: string;\r\n  maxUses: number;\r\n  restType: 'short' | 'long';\r\n  isPassive: boolean;\r\n  scaleWithProficiency: boolean;\r\n  proficiencyMultiplier: number;\r\n}\r\n\r\n/**\r\n * Convert partial extended feature to form data\r\n */\r\nexport function partialFeatureToFormData(\r\n  partial: Partial<ExtendedFeature>\r\n): FeatureFormData {\r\n  return {\r\n    name: partial.name || '',\r\n    description: partial.description || '',\r\n    sourceType: partial.sourceType || 'other',\r\n    sourceDetail: partial.sourceDetail || '',\r\n    category: partial.category || '',\r\n    maxUses: partial.maxUses || 0,\r\n    restType: partial.restType || 'long',\r\n    isPassive: partial.isPassive ?? true,\r\n    scaleWithProficiency: partial.scaleWithProficiency ?? false,\r\n    proficiencyMultiplier: partial.proficiencyMultiplier || 1,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3558, "column": 0}, "map": {"version":3,"sources":["file:///home/irakli/Projects/RollKeeper/apps/web/src/utils/spellConversion.ts"],"sourcesContent":["/**\r\n * Spell Conversion Utility\r\n * Converts ProcessedSpell (spellbook) to character Spell format\r\n */\r\n\r\nimport { ProcessedSpell } from '@/types/spells';\r\nimport { Spell, SpellActionType } from '@/types/character';\r\nimport { formatSpellDescriptionForEditor } from './referenceParser';\r\n\r\n/**\r\n * Convert ProcessedSpell (from spellbook) to SpellFormData (for character sheet)\r\n */\r\nexport interface SpellFormData {\r\n  name: string;\r\n  level: number;\r\n  school: string;\r\n  castingTime: string;\r\n  range: string;\r\n  components: {\r\n    verbal: boolean;\r\n    somatic: boolean;\r\n    material: boolean;\r\n    materialDescription: string;\r\n  };\r\n  duration: string;\r\n  description: string;\r\n  higherLevel: string;\r\n  ritual: boolean;\r\n  concentration: boolean;\r\n  isPrepared: boolean;\r\n  isAlwaysPrepared: boolean;\r\n  actionType: SpellActionType | '';\r\n  savingThrow: string;\r\n  damage: string;\r\n  damageType: string;\r\n  source: string;\r\n}\r\n\r\n/**\r\n * Extract damage dice from description tags like {@damage 1d8} or {@dice 1d6}\r\n */\r\nfunction extractDamageDice(description: string): string {\r\n  // Match {@damage XdY} or {@dice XdY} patterns\r\n  const damagePattern = /\\{@(?:damage|dice)\\s+(\\d+d\\d+(?:\\s*\\+\\s*\\d+)?)\\}/i;\r\n  const match = description.match(damagePattern);\r\n\r\n  if (match && match[1]) {\r\n    return match[1].trim();\r\n  }\r\n\r\n  // Also try to find standalone dice notation (e.g., \"takes 3d6 fire damage\")\r\n  const standaloneDicePattern =\r\n    /(?:takes|deals?)\\s+(\\d+d\\d+(?:\\s*\\+\\s*\\d+)?)\\s+(?:damage|fire|cold|lightning|thunder|acid|poison|necrotic|radiant|psychic|force)/i;\r\n  const standaloneMatch = description.match(standaloneDicePattern);\r\n\r\n  if (standaloneMatch && standaloneMatch[1]) {\r\n    return standaloneMatch[1].trim();\r\n  }\r\n\r\n  return '';\r\n}\r\n\r\n/**\r\n * Normalize casting time to match character sheet format\r\n */\r\nfunction normalizeCastingTime(castingTime: string): string {\r\n  // Handle common formatting differences\r\n  const normalized = castingTime.toLowerCase().trim();\r\n\r\n  // Convert \"1 bonus\" to \"1 bonus action\"\r\n  if (normalized === '1 bonus') {\r\n    return '1 bonus action';\r\n  }\r\n\r\n  // Convert \"1 reaction\" to match (already correct, but ensure consistency)\r\n  if (normalized.match(/^1 reaction/)) {\r\n    return '1 reaction';\r\n  }\r\n\r\n  // Convert \"N actions\" to \"1 action\" (most common)\r\n  if (normalized.match(/^\\d+ action$/)) {\r\n    return castingTime.replace(/(\\d+) action$/, '$1 action');\r\n  }\r\n\r\n  // Return as-is if already in correct format\r\n  return castingTime;\r\n}\r\n\r\n/**\r\n * Infer action type from spell metadata\r\n */\r\nfunction inferActionType(spell: ProcessedSpell): SpellActionType | '' {\r\n  // If spell has saving throws, it's likely a save spell\r\n  if (spell.saves && spell.saves.length > 0) {\r\n    return 'save';\r\n  }\r\n\r\n  // Check tags for attack-related indicators\r\n  const attackTags = [\r\n    'attack',\r\n    'spell attack',\r\n    'ranged spell attack',\r\n    'melee spell attack',\r\n  ];\r\n  const hasAttackTag = spell.tags?.some(tag =>\r\n    attackTags.some(attackTag => tag.toLowerCase().includes(attackTag))\r\n  );\r\n\r\n  if (hasAttackTag) {\r\n    return 'attack';\r\n  }\r\n\r\n  // Check description for attack keywords\r\n  const descriptionLower = spell.description.toLowerCase();\r\n  if (\r\n    descriptionLower.includes('spell attack') ||\r\n    descriptionLower.includes('attack roll')\r\n  ) {\r\n    return 'attack';\r\n  }\r\n\r\n  // Check description for saving throw keywords\r\n  if (\r\n    descriptionLower.includes('saving throw') ||\r\n    descriptionLower.includes('must succeed')\r\n  ) {\r\n    return 'save';\r\n  }\r\n\r\n  // Default to utility if no clear indicators\r\n  return 'utility';\r\n}\r\n\r\n/**\r\n * Convert ProcessedSpell to SpellFormData\r\n */\r\nexport function convertProcessedSpellToFormData(\r\n  spell: ProcessedSpell\r\n): SpellFormData {\r\n  const actionType = inferActionType(spell);\r\n\r\n  // Extract damage dice from description (still parse this as it's not in JSON)\r\n  const extractedDamage = extractDamageDice(spell.description);\r\n\r\n  // Get damage type from spell metadata (damageInflict property) - more reliable!\r\n  const damageType = spell.damage?.[0] || '';\r\n\r\n  // Get saving throw from spell metadata - more reliable!\r\n  const savingThrow = spell.saves?.[0] || '';\r\n\r\n  // Capitalize first letter of saving throw if it exists\r\n  const formattedSavingThrow = savingThrow\r\n    ? savingThrow.charAt(0).toUpperCase() + savingThrow.slice(1)\r\n    : '';\r\n\r\n  // Format descriptions for WYSIWYG editor with bold references\r\n  const formattedDescription = formatSpellDescriptionForEditor(\r\n    spell.description\r\n  );\r\n  const formattedHigherLevel = spell.higherLevelDescription\r\n    ? formatSpellDescriptionForEditor(spell.higherLevelDescription)\r\n    : '';\r\n\r\n  return {\r\n    name: spell.name,\r\n    level: spell.level,\r\n    school: spell.schoolName, // Use full school name\r\n    castingTime: normalizeCastingTime(spell.castingTime), // Normalize casting time format\r\n    range: spell.range,\r\n    components: {\r\n      verbal: spell.components.verbal,\r\n      somatic: spell.components.somatic,\r\n      material: spell.components.material,\r\n      materialDescription: spell.components.materialComponent || '',\r\n    },\r\n    duration: spell.duration,\r\n    description: formattedDescription,\r\n    higherLevel: formattedHigherLevel,\r\n    ritual: spell.isRitual,\r\n    concentration: spell.concentration,\r\n    isPrepared: false, // Default to unprepared\r\n    isAlwaysPrepared: false, // Default to not always prepared\r\n    actionType: actionType,\r\n    savingThrow: formattedSavingThrow, // Use from metadata (e.g., \"Dexterity\")\r\n    damage: extractedDamage, // Use extracted damage dice from description\r\n    damageType: damageType, // Use from metadata (e.g., \"fire\")\r\n    source: spell.source,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert SpellFormData to character Spell\r\n */\r\nexport function convertFormDataToSpell(\r\n  formData: SpellFormData,\r\n  existingId?: string\r\n): Spell {\r\n  const now = new Date().toISOString();\r\n\r\n  return {\r\n    id:\r\n      existingId ||\r\n      `spell_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n    name: formData.name,\r\n    level: formData.level,\r\n    school: formData.school,\r\n    castingTime: formData.castingTime,\r\n    range: formData.range,\r\n    components: {\r\n      verbal: formData.components.verbal,\r\n      somatic: formData.components.somatic,\r\n      material: formData.components.material,\r\n      materialDescription: formData.components.materialDescription || undefined,\r\n    },\r\n    duration: formData.duration,\r\n    description: formData.description,\r\n    higherLevel: formData.higherLevel || undefined,\r\n    ritual: formData.ritual || undefined,\r\n    concentration: formData.concentration || undefined,\r\n    isPrepared: formData.isPrepared || undefined,\r\n    isAlwaysPrepared: formData.isAlwaysPrepared || undefined,\r\n    actionType: formData.actionType || undefined,\r\n    savingThrow: formData.savingThrow || undefined,\r\n    damage: formData.damage || undefined,\r\n    damageType: formData.damageType || undefined,\r\n    source: formData.source || undefined,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n  };\r\n}\r\n\r\n/**\r\n * Search and filter spells by query\r\n */\r\nexport function searchSpells(\r\n  spells: ProcessedSpell[],\r\n  query: string\r\n): ProcessedSpell[] {\r\n  if (!query.trim()) {\r\n    return spells;\r\n  }\r\n\r\n  const queryLower = query.toLowerCase().trim();\r\n\r\n  return spells\r\n    .filter(spell => {\r\n      const nameLower = spell.name.toLowerCase();\r\n      const schoolLower = spell.schoolName.toLowerCase();\r\n      const descriptionLower = spell.description.toLowerCase();\r\n\r\n      return (\r\n        nameLower.includes(queryLower) ||\r\n        schoolLower.includes(queryLower) ||\r\n        descriptionLower.includes(queryLower) ||\r\n        spell.tags?.some(tag => tag.toLowerCase().includes(queryLower))\r\n      );\r\n    })\r\n    .sort((a, b) => {\r\n      // Sort by relevance: exact match first, then starts with, then contains\r\n      const aName = a.name.toLowerCase();\r\n      const bName = b.name.toLowerCase();\r\n\r\n      const aExact = aName === queryLower;\r\n      const bExact = bName === queryLower;\r\n      if (aExact && !bExact) return -1;\r\n      if (!aExact && bExact) return 1;\r\n\r\n      const aStarts = aName.startsWith(queryLower);\r\n      const bStarts = bName.startsWith(queryLower);\r\n      if (aStarts && !bStarts) return -1;\r\n      if (!aStarts && bStarts) return 1;\r\n\r\n      // Then sort alphabetically\r\n      return aName.localeCompare(bName);\r\n    });\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}